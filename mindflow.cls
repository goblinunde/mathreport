% =========================================================
% MindFlow - æ•°å­¦ä¸æ·±åº¦å­¦ä¹ ç¬”è®°ç±» (MindFlow Class)
% æ–‡ä»¶å: mindflow.cls
% ç‰ˆæœ¬: v1.0 (2026/01/05)
% æè¿°: ä¸“ä¸ºæ•°å­¦(PDE/åˆ†æ)ä¸æ·±åº¦å­¦ä¹ ç¬”è®°è®¾è®¡çš„æ¨¡å—åŒ– LaTeX ç±»æ–‡ä»¶
% åŸå‹: åŸºäº hustreport é‡æ„
%
% ğŸ“Œ æ¨¡å—ç»“æ„ç´¢å¼• (Module Index):
% [01] æ ¸å¿ƒé€‰é¡¹å®šä¹‰ ....... (Options: Mode, Fonts, Platforms)
% [02] åŸºç±»åŠ è½½ ........... (Base Class: ctexart/book/rep)
% [03] å®åŒ…ä¾èµ–åº“ ......... (Packages: Math, Graphics, Tables)
% [04] å­—ä½“æ™ºèƒ½é…ç½® ....... (Fonts: Auto-detect OS & Fonts)
% [05] é¡µé¢ç‰ˆå¼è®¾ç½® ....... (Geometry: Margins, Headers)
% [06] ç« èŠ‚æ ‡é¢˜æ ·å¼ ....... (Headings: Visual Designs)
% [07] è®¡æ•°å™¨ä¸ç¼–å· ....... (Counters: Eq/Fig/Tab numbering)
% [08] å›¾è¡¨æµ®åŠ¨ä½“ ......... (Floats: Caption styles)
% [09] æ•°å­¦å®šç†ç¯å¢ƒ ....... (Theorems: Color-coded boxes)
% [10] å­¦ç§‘ä¸“ç”¨å®åº“ ....... (Macros: PDE operators, DL symbols)
% [11] PDFå±æ€§å…ƒæ•°æ® ...... (Hyperref: Metadata settings)
% [12] é«˜çº§å›¾æ–‡æ’ç‰ˆ ....... (Layout: TextFigure, ParallelFigs)
% [13] ä»£ç é«˜äº®ç¯å¢ƒ ....... (Code: Listings, TColorBox)
% [14] è¯­ä¹‰åŒ–æç¤ºæ¡† ....... (Boxes: Notice, Tip, Warning)
% [15] åˆ—è¡¨ç¯å¢ƒä¼˜åŒ– ....... (Lists: Itemize, Enumerate)
% [16] å¯¼è¯»ä¸æ€»ç»“ ......... (Structure: Intro/Summary Box)
% [17] æ‰¹æ³¨ç³»ç»Ÿ ........... (Review: Todo, Fixme, Note)
% [18] æ•™ç¨‹æ¼”ç¤ºç³»ç»Ÿ ....... (Demo: Code/Result visualization)
% [19] é™„å½•ä¸å‚è€ƒæ–‡çŒ® ..... (Backmatter: Appendix, Bib)
% [20] è¾…åŠ©å·¥å…· ........... (Utils: Dirtree etc.)
% =========================================================

% ---------------------------------------------------------
% 0. ç‰ˆæœ¬ä¸æ ¼å¼å£°æ˜
% ---------------------------------------------------------
\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{mindflow}[2026/01/05 v1.0 MindFlow Math & DL Notes Class]

% [0.1] è­¦å‘Šå±è”½ (Silence Warnings)
\RequirePackage{silence}
\WarningFilter{tocbasic}{Unknown message} % å±è”½æ‰€æœ‰ tocbasic ä¸è¯†åˆ«æ¶ˆæ¯
\WarningFilter{siunitx}{Detected} % å±è”½ siunitx/physics å†²çª
\WarningFilter{latex}{Font shape} % å±è”½ Fandol å­—ä½“æ›¿æ¢è­¦å‘Š

% [0.2] ä¿®å¤ KOMA-Script 3.49 tocbasic bug
% ğŸ’¡ tocbasic.sty ç¬¬ 1376 è¡Œåœ¨ç¬¬ 1378 è¡Œå®šä¹‰å‰è°ƒç”¨æ¶ˆæ¯ï¼Œè¿™æ˜¯ä¸Šæ¸¸ bug
%    æˆ‘ä»¬å…ˆå®šä¹‰æ¶ˆæ¯ï¼Œç„¶åä¸´æ—¶è¡¥ä¸ msg_new ä½¿å…¶å¿½ç•¥é‡å¤å®šä¹‰
\ExplSyntaxOn
% å…ˆé¢„å®šä¹‰ç¼ºå¤±çš„æ¶ˆæ¯
\msg_new:nnn { tocbasic } { caption-code-by-class-deactivated }
  { KOMA-Script~3.49~bug~workaround~(MindFlow). }

% ä¿å­˜åŸå§‹çš„ msg_new:nnnnï¼Œå¹¶åˆ›å»ºä¸€ä¸ªå…è®¸é‡å¤å®šä¹‰çš„ç‰ˆæœ¬
\cs_set_eq:NN \mf_msg_new_orig:nnnn \msg_new:nnnn
\cs_set:Npn \msg_new:nnnn #1#2#3#4 {
  \msg_if_exist:nnTF {#1} {#2}
    { } % å¦‚æœå·²å­˜åœ¨ï¼Œé™é»˜è·³è¿‡
    { \mf_msg_new_orig:nnnn {#1} {#2} {#3} {#4} }
}
\cs_set_eq:NN \mf_msg_new_orig:nnn \msg_new:nnn  
\cs_set:Npn \msg_new:nnn #1#2#3 {
  \msg_if_exist:nnTF {#1} {#2}
    { } % å¦‚æœå·²å­˜åœ¨ï¼Œé™é»˜è·³è¿‡
    { \mf_msg_new_orig:nnn {#1} {#2} {#3} }
}
\ExplSyntaxOff


% ---------------------------------------------------------
% 1. æ ¸å¿ƒé€‰é¡¹å®šä¹‰
% ---------------------------------------------------------
% [1.1] ç³»ç»Ÿå¹³å°æ£€æµ‹å¼€å…³
\newif\ifmf@oswin    \mf@oswinfalse
\newif\ifmf@osmac    \mf@osmacfalse
\newif\ifmf@oslinux  \mf@oslinuxfalse
\newif\ifmf@optfonts \mf@optfontsfalse

% [1.2] æ–‡æ¡£æ¨¡å¼å¼€å…³ (note/book/report)
\newif\ifmf@note     \mf@notetrue   % ğŸ’¡ é»˜è®¤ä¸º note æ¨¡å¼
\newif\ifmf@book     \mf@bookfalse
\newif\ifmf@report   \mf@reportfalse

% [1.3] ç¼–å·æ¨¡å¼å¼€å…³
\newif\ifmf@chapnum  \mf@chapnumfalse % æ˜¯å¦æŒ‰ç« èŠ‚ç¼–å·

% [1.4] å£°æ˜å‚æ•°é€‰é¡¹
\DeclareOption{win}{\mf@oswintrue}
\DeclareOption{mac}{\mf@osmactrue}
\DeclareOption{linux}{\mf@oslinuxtrue}
\DeclareOption{fonts}{\mf@optfontstrue}

% æ–‡æ¡£æ¨¡å¼é€‰é¡¹
\DeclareOption{note}{%
    \mf@notetrue\mf@bookfalse\mf@reportfalse
}
\DeclareOption{book}{%
    \mf@notefalse\mf@booktrue\mf@reportfalse
    \mf@chapnumtrue % book æ¨¡å¼é»˜è®¤æŒ‰ç« ç¼–å·
}
\DeclareOption{report}{%
    \mf@notefalse\mf@bookfalse\mf@reporttrue
    \mf@chapnumtrue % report æ¨¡å¼é»˜è®¤æŒ‰ç« ç¼–å·
}

% ç¼–å·æ¨¡å¼
\DeclareOption{chapnum}{\mf@chapnumtrue}
\DeclareOption{nochapnum}{\mf@chapnumfalse}

% [1.5] Section æ ·å¼é€‰é¡¹
% classic: è“è‰²ç¼–å·å—+æµ…è“èƒŒæ™¯ (é»˜è®¤)
% modern:  æ¸å˜åº•è¾¹çº¿+å¤§å·ç¼–å·
% minimal: çº¯æ–‡æœ¬+å·¦ä¾§ç«–çº¿
% boxed:   å®Œæ•´è¾¹æ¡†å¡ç‰‡
% --- æè‡´ç¾åŒ–æ ·å¼ (v1.1) ---
% neon:      éœ“è™¹å‘å…‰è¾¹æ¡† (èµ›åšæœ‹å…‹é£)
% terminal:  ç»ˆç«¯é£æ ¼ (Hacker é£)
% gradient:  å¤šè‰²æ¸å˜èƒŒæ™¯ (ç§‘æŠ€æ„Ÿ)
% elegant:   é‡‘è‰²è£…é¥°çº¿ (å­¦æœ¯å…¸é›…)
% blueprint: è“å›¾ç½‘æ ¼èƒŒæ™¯ (å·¥ç¨‹å¸ˆé£)
% ribbon:    æŠ˜å ä¸å¸¦æ•ˆæœ (ç²¾è‡´å¡ç‰‡)
\def\mf@secstyle{classic}
\DeclareOption{secstyle-classic}{\def\mf@secstyle{classic}}
\DeclareOption{secstyle-modern}{\def\mf@secstyle{modern}}
\DeclareOption{secstyle-minimal}{\def\mf@secstyle{minimal}}
\DeclareOption{secstyle-boxed}{\def\mf@secstyle{boxed}}
\DeclareOption{secstyle-neon}{\def\mf@secstyle{neon}}
\DeclareOption{secstyle-terminal}{\def\mf@secstyle{terminal}}
\DeclareOption{secstyle-gradient}{\def\mf@secstyle{gradient}}
\DeclareOption{secstyle-elegant}{\def\mf@secstyle{elegant}}
\DeclareOption{secstyle-blueprint}{\def\mf@secstyle{blueprint}}
\DeclareOption{secstyle-ribbon}{\def\mf@secstyle{ribbon}}

% [1.6] å®¡ç¨¿æ¨¡å¼
\newif\ifmf@review \mf@reviewfalse
\DeclareOption{review}{\mf@reviewtrue}

% ä¼ é€’æœªå®šä¹‰é€‰é¡¹ç»™åº•å±‚ç±»
\DeclareOption*{%
    \ifmf@book
        \PassOptionsToClass{\CurrentOption}{ctexbook}%
    \else\ifmf@report
        \PassOptionsToClass{\CurrentOption}{ctexrep}%
    \else
        \PassOptionsToClass{\CurrentOption}{ctexart}%
    \fi\fi
}
\ProcessOptions\relax

% ---------------------------------------------------------
% 2. åŸºç±»åŠ è½½ (æ ¹æ®æ¨¡å¼é€‰æ‹©)
% ---------------------------------------------------------
% [å‚æ•°è¯´æ˜]
% a4paper: A4çº¸å¼ 
% UTF8: ç¼–ç æ ¼å¼
% zihao=-4: æ­£æ–‡é»˜è®¤å°å››å·å­—
% linespread=1.5: é»˜è®¤ 1.5 å€è¡Œè·
\ifmf@book
    \LoadClass[a4paper,UTF8,zihao=-4,linespread=1.5]{ctexbook}
    \typeout{>> [MindFlow] Loading book mode (ctexbook)}
\else\ifmf@report
    \LoadClass[a4paper,UTF8,zihao=-4,linespread=1.5]{ctexrep}
    \typeout{>> [MindFlow] Loading report mode (ctexrep)}
\else
    \LoadClass[a4paper,UTF8,zihao=-4,linespread=1.5]{ctexart}
    \typeout{>> [MindFlow] Loading note mode (ctexart)}
\fi\fi


% ---------------------------------------------------------
% 3. å®åŒ…åŠ è½½ (æŒ‰åŠŸèƒ½åˆ†ç±»)
% ---------------------------------------------------------

% [3.1] é¡µé¢ä¸å¸ƒå±€
\RequirePackage{geometry}   % é¡µé¢è¾¹è·è®¾ç½®
\RequirePackage{fancyhdr}   % é¡µçœ‰é¡µè„šå®šåˆ¶
\RequirePackage{float}      % æµ®åŠ¨ä½“æ§åˆ¶ (Hå‚æ•°)
\RequirePackage[sort&compress,numbers,square]{natbib} % å‚è€ƒæ–‡çŒ®ç®¡ç†

% [3.2] æ ‡é¢˜ä¸ç›®å½•
\RequirePackage{titletoc}   % ç›®å½•æ ¼å¼å®šåˆ¶
\RequirePackage{titlesec}   % ç« èŠ‚æ ‡é¢˜æ ¼å¼å®šåˆ¶

% [3.3] æ•°å­¦ä¸ç‰©ç†
\RequirePackage{amsmath,amssymb,amsfonts,amsthm} % æ•°å­¦å…¬å¼æ ¸å¿ƒåŒ…
\RequirePackage{physics}    % ç‰©ç†ç¬¦å·ä¾¿æ·åŒ…
\RequirePackage{siunitx}    % å›½é™…å•ä½åˆ¶æ”¯æŒ
\RequirePackage{newtxmath}  % æ•°å­¦å­—ä½“ä¼˜åŒ–
\RequirePackage{calc}       % é•¿åº¦è®¡ç®—æ”¯æŒ
\RequirePackage{bm}         % ç²—ä½“æ•°å­¦ç¬¦å·

% [3.4] å›¾å½¢ä¸é¢œè‰²
\RequirePackage{graphicx}   % å›¾ç‰‡æ’å…¥
\RequirePackage{subcaption} % å­å›¾æ”¯æŒ
\RequirePackage{tikz}       % ç»˜å›¾ä¸ç»å¯¹å®šä½
\RequirePackage{tikz-3dplot} % 3D å‡ ä½•ç»˜å›¾
\RequirePackage[dvipsnames, svgnames, x11names]{xcolor} % é¢œè‰²æ”¯æŒ

% [3.5] è¡¨æ ¼ä¸åˆ—è¡¨
\RequirePackage{booktabs}   % ä¸‰çº¿è¡¨æ”¯æŒ
\RequirePackage{threeparttable}
\RequirePackage{caption}
\RequirePackage{tabularx}   % è‡ªé€‚åº”å®½åº¦è¡¨æ ¼
\RequirePackage{xltabular}  % è·¨é¡µé•¿è¡¨æ ¼
\RequirePackage{multirow}   % è¡¨æ ¼å¤šè¡Œåˆå¹¶
\RequirePackage{makecell}   % è¡¨æ ¼å•å…ƒæ ¼æ¢è¡Œ
\RequirePackage{array}      % è¡¨æ ¼åˆ—æ ¼å¼æ‰©å±•
\RequirePackage{enumitem}   % åˆ—è¡¨ç¯å¢ƒå®šåˆ¶
\RequirePackage{diagbox}

% [3.6] å­—ä½“ä¸ä¿®é¥°
\RequirePackage{anyfontsize} % ä»»æ„å­—å·æ”¯æŒ

% [3.7] è¶…é“¾æ¥ä¸PDFå±æ€§
\RequirePackage{hyperref}   % è¶…é“¾æ¥æ”¯æŒ

% [3.8] é«˜çº§åŠŸèƒ½
\RequirePackage{xparse}     % é«˜çº§å‚æ•°å¤„ç†
\RequirePackage[normalem]{ulem} % ä¸‹åˆ’çº¿æ”¯æŒ
\RequirePackage{etoolbox}   % æ¡ä»¶åˆ¤æ–­ (æä¾› \ifblank ç­‰)
\RequirePackage{algorithm}  % ç®—æ³•ä¼ªä»£ç ç¯å¢ƒ
\RequirePackage{algpseudocode}
% ---------------------------------------------------------
% 21. å­¦æœ¯åŠŸèƒ½æ‰©å±• (New)
% ---------------------------------------------------------
% [21.1] å®¡ç¨¿æ¨¡å¼ (Review Mode)
\ifmf@review
    \RequirePackage{lineno}
    \linenumbers
\fi
% (Note: \ProcessOptions moved to top)

% [21.1.1] æ°´å°ç³»ç»Ÿ (Watermark System)
\RequirePackage[stamp=false]{draftwatermark} % é»˜è®¤ä¸æ˜¾ç¤º

% æ–‡æœ¬æ°´å°å‘½ä»¤
% ç”¨æ³•: \mfWatermarkText[color][scale]{Content}
% ç¤ºä¾‹: \mfWatermarkText[red!15][6]{ç»å¯†}
\NewDocumentCommand{\mfWatermarkText}{O{gray!25} O{4} m}{%
    \DraftwatermarkOptions{
        stamp=true,
        text={\bfseries #3},
        color=#1,
        scale=#2
    }%
}

% å›¾ç‰‡æ°´å°å‘½ä»¤
% ç”¨æ³•: \mfWatermarkImage{path/to/image}
% ç¤ºä¾‹: \mfWatermarkImage{figure/logo.png}
\NewDocumentCommand{\mfWatermarkImage}{m}{%
    \DraftwatermarkOptions{
        stamp=true,
        text={\includegraphics{#1}},
        scale=1,
        color=white % é¿å…æ–‡æœ¬é¢œè‰²å½±å“å›¾ç‰‡
    }%
}

% [21.2] ç§‘å­¦ç»˜å›¾ (PGFPlots)
\RequirePackage{pgfplots}
\pgfplotsset{compat=1.18}

% å®šä¹‰ MindFlow ç»˜å›¾é£æ ¼
\pgfplotsset{
    mfplot/.style={
        width=0.8\textwidth,
        height=0.5\textwidth,
        grid=major,
        grid style={dashed,gray!30},
        xlabel style={font=\small\bfseries},
        ylabel style={font=\small\bfseries},
        legend style={
            at={(0.95,0.05)},
            anchor=south east,
            draw=none,
            fill=white,
            fill opacity=0.8,
            font=\small
        },
        cycle list={
            {mf@thm@blue, thick, mark=*},
            {mf@cor@orange, thick, mark=square*},
            {mf@def@green, thick, mark=triangle*},
            {mf@prop@purple, thick, mark=diamond*},
            {red, thick, mark=x},
        }
    },
    % === æ·±è‰²ä¸»é¢˜æ ·å¼ ===
    mfplot-dark/.style={
        width=0.8\textwidth,
        height=0.5\textwidth,
        axis background/.style={fill=black!90},
        axis line style={white},
        tick style={white},
        tick label style={white},
        label style={white},
        title style={white, font=\bfseries},
        grid=major,
        grid style={gray!40},
        xlabel style={font=\small\bfseries},
        ylabel style={font=\small\bfseries},
        legend style={
            at={(0.95,0.95)},
            anchor=north east,
            fill=black!70,
            text=white,
            font=\small
        },
        cycle list={
            {cyan, thick, mark=*},
            {yellow, thick, mark=square*},
            {magenta, thick, mark=triangle*},
            {green, thick, mark=diamond*},
            {orange, thick, mark=x},
        }
    },
    % === æç®€æ ·å¼ ===
    mfplot-minimal/.style={
        width=0.8\textwidth,
        height=0.5\textwidth,
        axis lines=left,
        axis line style={->,thick},
        xlabel style={font=\small\bfseries},
        ylabel style={font=\small\bfseries},
        xtick style={draw=none},
        ytick style={draw=none},
        legend style={
            at={(0.5,-0.15)},
            anchor=north,
            draw=none,
            font=\small,
            legend columns=-1
        },
        cycle list={
            {mf@thm@blue, thick},
            {mf@cor@orange, thick, dashed},
            {mf@def@green, thick, dotted},
        }
    },
    % === æŸ±çŠ¶å›¾æ ·å¼ ===
    mfplot-bar/.style={
        width=0.8\textwidth,
        height=0.5\textwidth,
        ybar,
        bar width=15pt,
        enlarge x limits=0.15,
        ymajorgrids=true,
        grid style={dashed,gray!30},
        xlabel style={font=\small\bfseries},
        ylabel style={font=\small\bfseries},
        legend style={
            at={(0.5,-0.15)},
            anchor=north,
            legend columns=-1,
            draw=none,
            font=\small
        },
        symbolic x coords={A,B,C,D,E},
        xtick=data,
    },
    % === æ•£ç‚¹å›¾æ ·å¼ ===
    mfplot-scatter/.style={
        width=0.8\textwidth,
        height=0.5\textwidth,
        only marks,
        mark size=2pt,
        grid=major,
        grid style={dashed,gray!20},
        xlabel style={font=\small\bfseries},
        ylabel style={font=\small\bfseries},
        legend style={
            at={(0.95,0.95)},
            anchor=north east,
            draw=none,
            fill=white,
            fill opacity=0.8,
            font=\small
        },
    },
    % === å¡«å……é¢ç§¯å›¾æ ·å¼ ===
    mfplot-area/.style={
        width=0.8\textwidth,
        height=0.5\textwidth,
        area style,
        stack plots=y,
        grid=major,
        grid style={dashed,gray!20},
        xlabel style={font=\small\bfseries},
        ylabel style={font=\small\bfseries},
        legend style={
            at={(0.5,-0.15)},
            anchor=north,
            legend columns=-1,
            draw=none,
            font=\small
        },
    }
}

% ---------------------------------------------------------
% [21.4] TikZ ç»˜å›¾æ ·å¼åº“ (æ‹“æ‰‘å›¾/å›¾è®º/ç¥ç»ç½‘ç»œ/æµç¨‹å›¾)
% ---------------------------------------------------------
\usetikzlibrary{arrows.meta, positioning, shapes.geometric, shapes.misc, 
                calc, fit, backgrounds, decorations.pathreplacing, 
                decorations.markings, patterns, shadows, matrix, tqft}

% === é€šç”¨èŠ‚ç‚¹æ ·å¼ ===
\tikzset{
    % åŸºç¡€èŠ‚ç‚¹
    mf@node/.style={
        draw, 
        thick, 
        minimum size=8mm,
        font=\small
    },
    % åœ†å½¢èŠ‚ç‚¹ (å›¾è®º/æ‹“æ‰‘)
    mfnode/.style={
        mf@node,
        circle,
        fill=mf@thm@blue!20,
        draw=mf@thm@blue
    },
    % æ–¹å½¢èŠ‚ç‚¹
    mfbox/.style={
        mf@node,
        rectangle,
        rounded corners=2pt,
        fill=mf@def@green!15,
        draw=mf@def@green
    },
    % è±å½¢èŠ‚ç‚¹ (åˆ¤æ–­)
    mfdiamond/.style={
        mf@node,
        diamond,
        aspect=1.5,
        fill=mf@cor@orange!20,
        draw=mf@cor@orange
    },
    % æ¤­åœ†èŠ‚ç‚¹ (å¼€å§‹/ç»“æŸ)
    mfellipse/.style={
        mf@node,
        ellipse,
        fill=mf@prop@purple!15,
        draw=mf@prop@purple
    },
}

% === ç¥ç»ç½‘ç»œæ ·å¼ ===
\tikzset{
    % ç¥ç»å…ƒèŠ‚ç‚¹
    neuron/.style={
        circle,
        draw=mf@thm@blue,
        fill=mf@thm@blue!25,
        minimum size=10mm,
        thick,
        font=\small
    },
    % è¾“å…¥å±‚èŠ‚ç‚¹
    input neuron/.style={
        neuron,
        draw=mf@def@green,
        fill=mf@def@green!25
    },
    % è¾“å‡ºå±‚èŠ‚ç‚¹
    output neuron/.style={
        neuron,
        draw=mf@cor@orange,
        fill=mf@cor@orange!25
    },
    % éšè—å±‚èŠ‚ç‚¹
    hidden neuron/.style={
        neuron,
        draw=mf@prop@purple,
        fill=mf@prop@purple!20
    },
    % ç¥ç»ç½‘ç»œè¿æ¥çº¿
    nnedge/.style={
        ->,
        >=Stealth,
        thick,
        draw=gray!60
    },
}

% === å›¾è®º/æ‹“æ‰‘æ ·å¼ ===
\tikzset{
    % å›¾è®ºè¾¹ (æ— å‘)
    graphedge/.style={
        thick,
        draw=mf@thm@blue!70
    },
    % å›¾è®ºè¾¹ (æœ‰å‘)
    dirgraphedge/.style={
        ->,
        >=Stealth,
        thick,
        draw=mf@thm@blue!80
    },
    % åŠ æƒè¾¹æ ‡ç­¾
    edgelabel/.style={
        font=\footnotesize,
        fill=white,
        inner sep=1pt
    },
    % é«˜äº®èŠ‚ç‚¹
    highlight node/.style={
        fill=mf@cor@orange!40,
        draw=mf@cor@orange,
        line width=2pt
    },
    % é«˜äº®è¾¹
    highlight edge/.style={
        draw=red!70,
        line width=2pt
    },
}

% === æµç¨‹å›¾æ ·å¼ ===
\tikzset{
    % æµç¨‹å›¾ç®­å¤´
    flowedge/.style={
        ->,
        >=Stealth,
        thick,
        draw=gray!70
    },
    % å¤„ç†æ¡†
    process/.style={
        rectangle,
        rounded corners=3pt,
        draw=mf@thm@blue,
        fill=mf@thm@blue!10,
        minimum width=25mm,
        minimum height=10mm,
        font=\small,
        thick
    },
    % åˆ¤æ–­æ¡†
    decision/.style={
        diamond,
        aspect=2,
        draw=mf@cor@orange,
        fill=mf@cor@orange!10,
        minimum width=20mm,
        minimum height=10mm,
        font=\small,
        thick
    },
    % å¼€å§‹/ç»“æŸæ¡†
    terminal/.style={
        rounded rectangle,
        draw=mf@prop@purple,
        fill=mf@prop@purple!10,
        minimum width=20mm,
        minimum height=8mm,
        font=\small,
        thick
    },
    % æ•°æ®æ¡†
    io/.style={
        trapezium,
        trapezium left angle=70,
        trapezium right angle=110,
        draw=mf@def@green,
        fill=mf@def@green!10,
        minimum width=20mm,
        minimum height=8mm,
        font=\small,
        thick
    },
}

% === çŠ¶æ€æœºæ ·å¼ ===
\tikzset{
    % çŠ¶æ€èŠ‚ç‚¹
    state/.style={
        circle,
        draw=mf@thm@blue,
        fill=mf@thm@blue!15,
        minimum size=12mm,
        thick,
        font=\small
    },
    % åˆå§‹çŠ¶æ€
    initial state/.style={
        state,
        draw=mf@def@green,
        fill=mf@def@green!15
    },
    % ç»ˆæ­¢çŠ¶æ€
    final state/.style={
        state,
        double,
        double distance=2pt,
        draw=mf@cor@orange,
        fill=mf@cor@orange!15
    },
    % çŠ¶æ€è½¬ç§»è¾¹
    transition/.style={
        ->,
        >=Stealth,
        thick,
        draw=gray!70
    },
    % è‡ªç¯
    loop edge/.style={
        ->,
        >=Stealth,
        thick,
        looseness=5,
        draw=gray!70
    },
}

% === æ•°å­¦æ‹“æ‰‘æ ·å¼ ===
\tikzset{
    % æ‹“æ‰‘ç©ºé—´èƒŒæ™¯
    topology space/.style={
        draw=mf@thm@blue!50,
        fill=mf@thm@blue!5,
        rounded corners=5pt,
        dashed
    },
    % å¼€é›†
    open set/.style={
        draw=mf@def@green,
        fill=mf@def@green!10,
        thick
    },
    % é—­é›†
    closed set/.style={
        draw=mf@prop@purple,
        fill=mf@prop@purple!10,
        thick
    },
    % ç‚¹
    point/.style={
        circle,
        fill=black,
        inner sep=1.5pt
    },
    % è¿ç»­æ˜ å°„ç®­å¤´
    continuous map/.style={
        ->,
        >=Stealth,
        thick,
        draw=mf@cor@orange,
        decorate,
        decoration={snake, amplitude=0.5mm, segment length=3mm}
    },
}

% ---------------------------------------------------------
% [21.6] é«˜çº§æ‹“æ‰‘ç»˜å›¾å‘½ä»¤ (è«æ¯”ä¹Œæ–¯å¸¦/ç¯é¢/Kleinç“¶ç­‰)
% ---------------------------------------------------------
\usetikzlibrary{3d, perspective}

% === è«æ¯”ä¹Œæ–¯å¸¦ (MÃ¶bius Strip) ===
% ç”¨æ³•: \mobiusstrip[é€‰é¡¹]{xä½ç½®}{yä½ç½®}{å¤§å°}
\newcommand{\mobiusstrip}[4][]{
    \begin{scope}[shift={(#2,#3)}, scale=#4, #1]
        % å¤–è¾¹ç¼˜
        \draw[thick, mf@thm@blue] 
            plot[domain=0:360, samples=100, smooth] 
            ({(2+0.5*cos(\x/2))*cos(\x)}, {(2+0.5*cos(\x/2))*sin(\x)}, {0.5*sin(\x/2)});
        % å†…è¾¹ç¼˜ (æ‰­æ›²)
        \draw[thick, mf@prop@purple, dashed]
            plot[domain=0:360, samples=100, smooth] 
            ({(2-0.5*cos(\x/2))*cos(\x)}, {(2-0.5*cos(\x/2))*sin(\x)}, {-0.5*sin(\x/2)});
        % ä¸­çº¿
        \draw[mf@cor@orange, thick]
            plot[domain=0:360, samples=80, smooth] 
            ({2*cos(\x)}, {2*sin(\x)}, 0);
    \end{scope}
}

% === ç¯é¢ (Torus) ===
% ç”¨æ³•: \torus[é€‰é¡¹]{xä½ç½®}{yä½ç½®}{å¤§åŠå¾„}{å°åŠå¾„}
\newcommand{\torus}[5][]{
    \begin{scope}[shift={(#2,#3)}, #1]
        % å¤–è½®å»“
        \draw[thick, mf@thm@blue, fill=mf@thm@blue!10] 
            (0,0) ellipse ({#4+#5} and {(#4+#5)*0.4});
        % å†…å­”
        \draw[thick, mf@thm@blue, fill=white] 
            (0,0) ellipse ({#4-#5} and {(#4-#5)*0.4});
        % é¡¶éƒ¨è¾¹ç¼˜
        \draw[thick, mf@prop@purple]
            ({-#4},0) arc (180:360:{#4} and {#4*0.4});
        % ç»çº¿ç¤ºæ„
        \draw[mf@cor@orange, dashed] 
            ({#4},0) arc (0:180:{#5} and {#5*0.6});
        \draw[mf@cor@orange] 
            ({#4},0) arc (0:-180:{#5} and {#5*0.6});
    \end{scope}
}

% === çƒé¢ (Sphere) ===
\newcommand{\sphere}[4][]{
    \begin{scope}[shift={(#2,#3)}, #1]
        \draw[thick, mf@thm@blue, fill=mf@thm@blue!10] (0,0) circle (#4);
        % èµ¤é“
        \draw[mf@cor@orange] (0,0) ellipse ({#4} and {#4*0.3});
        % ç»çº¿
        \draw[mf@prop@purple, dashed] (0,{-#4}) arc (-90:90:{#4*0.3} and {#4});
        \draw[mf@prop@purple] (0,{-#4}) arc (270:90:{#4*0.3} and {#4});
    \end{scope}
}

% === åœ†æŸ±é¢ (Cylinder) ===
\newcommand{\cylinder}[5][]{
    \begin{scope}[shift={(#2,#3)}, #1]
        % ä¾§é¢
        \draw[thick, mf@thm@blue, fill=mf@thm@blue!8] 
            ({-#4},0) -- ({-#4},{#5}) 
            arc (180:360:{#4} and {#4*0.3}) 
            -- ({#4},0) arc (0:180:{#4} and {#4*0.3});
        % é¡¶é¢
        \draw[thick, mf@thm@blue, fill=mf@thm@blue!15] 
            (0,{#5}) ellipse ({#4} and {#4*0.3});
        % åº•é¢è™šçº¿
        \draw[dashed, mf@thm@blue] 
            ({-#4},0) arc (180:0:{#4} and {#4*0.3});
    \end{scope}
}

% === Klein ç“¶ (ç®€åŒ–å¹³é¢è¡¨ç¤º) ===
\newcommand{\kleinbottle}[4][]{
    \begin{scope}[shift={(#2,#3)}, scale=#4, #1]
        % ä¸»ä½“è½®å»“
        \draw[thick, mf@thm@blue] 
            (-1.5,-1) .. controls (-2,0) and (-2,1) .. (-1.5,1.5)
            .. controls (-1,2) and (0,2) .. (0.5,1.5)
            .. controls (1,1) and (1,0.5) .. (0.8,0)
            .. controls (0.6,-0.5) and (0,-0.8) .. (-0.5,-0.5)
            .. controls (-0.8,-0.3) and (-0.8,0.3) .. (-0.5,0.5)
            .. controls (0,0.8) and (0.5,0.5) .. (0.5,0)
            .. controls (0.5,-0.5) and (0,-1) .. (-0.5,-1)
            .. controls (-1,-1) and (-1.5,-1) .. (-1.5,-1);
        % è‡ªäº¤å‰æ ‡è®°
        \draw[mf@cor@orange, thick, dashed] 
            (-0.5,-0.5) .. controls (-0.2,-0.2) .. (0.2,0.2);
        % ç®­å¤´æŒ‡ç¤º
        \draw[->, >=Stealth, mf@prop@purple, thick] 
            (-1.5,0) -- (-1.5,0.8);
        \draw[->, >=Stealth, mf@prop@purple, thick] 
            (0.8,-0.5) -- (0.8,0.3);
    \end{scope}
}

% === ç¯ (Circle/Loop) ===
\newcommand{\topologyloop}[4][]{
    \begin{scope}[shift={(#2,#3)}, #1]
        \draw[thick, mf@thm@blue, fill=mf@thm@blue!10] (0,0) circle (#4);
        \node[point] at (0,{#4}) {};
        \node[above] at (0,{#4}) {\small åŸºç‚¹};
    \end{scope}
}

% === åŸºæœ¬ç¾¤ç¤ºæ„ (å…«å­—å½¢) ===
\newcommand{\bouquet}[4][]{
    \begin{scope}[shift={(#2,#3)}, scale=#4, #1]
        \draw[thick, mf@thm@blue, fill=mf@thm@blue!10] (-0.8,0) circle (0.8);
        \draw[thick, mf@prop@purple, fill=mf@prop@purple!10] (0.8,0) circle (0.8);
        \node[point] at (0,0) {};
        \node[below] at (0,-0.2) {\small $\ast$};
        % ç”Ÿæˆå…ƒæ ‡è®°
        \node at (-0.8,0) {$a$};
        \node at (0.8,0) {$b$};
    \end{scope}
}

% === åŒä¼¦ç­‰ä»·ç®­å¤´ ===
\tikzset{
    homotopy arrow/.style={
        <->,
        >=Stealth,
        thick,
        draw=mf@def@green,
        decorate,
        decoration={snake, amplitude=0.8mm, segment length=4mm, post length=2mm, pre length=2mm}
    },
}

% === çº¤ç»´ä¸›ç¤ºæ„ ===
\newcommand{\fiberbundle}[5][]{
    \begin{scope}[shift={(#2,#3)}, #1]
        % åº•ç©ºé—´ B
        \draw[thick, mf@thm@blue, fill=mf@thm@blue!10] 
            (0,0) ellipse ({#4} and {#4*0.3});
        \node[below] at (0,{-#4*0.3-0.3}) {$B$};
        % çº¤ç»´ F
        \foreach \x in {-0.6,-0.2,0.2,0.6} {
            \draw[mf@prop@purple, thick] 
                ({\x*#4},0) -- ({\x*#4},{#5});
        }
        % æ€»ç©ºé—´ E
        \draw[thick, mf@cor@orange, dashed] 
            ({-#4},{#5}) -- ({#4},{#5});
        \node[above] at (0,{#5}) {$E$};
        % æŠ•å½±ç®­å¤´
        \draw[->, >=Stealth, thick] 
            ({#4+0.5},{#5*0.5}) -- ({#4+0.5},0.1) node[midway, right] {$\pi$};
    \end{scope}
}

% ---------------------------------------------------------
% [21.7] äº¤æ¢å›¾æ ·å¼ (ä»£æ•°æ‹“æ‰‘/èŒƒç•´è®º)
% ---------------------------------------------------------
\tikzset{
    % äº¤æ¢å›¾ç®­å¤´
    cd arrow/.style={
        ->,
        >=Stealth,
        thick
    },
    % å•å°„
    cd mono/.style={
        cd arrow,
        >={Hooks[right]}
    },
    % æ»¡å°„
    cd epi/.style={
        cd arrow,
        ->>
    },
    % åŒæ„
    cd iso/.style={
        cd arrow,
        <->
    },
    % è™šçº¿ç®­å¤´ (å­˜åœ¨æ€§)
    cd exists/.style={
        cd arrow,
        dashed
    },
    % äº¤æ¢å›¾èŠ‚ç‚¹
    cd node/.style={
        font=\normalsize,
        inner sep=3pt
    },
}

% ---------------------------------------------------------
% [21.8] å‘é‡åœºä¸å¾®åˆ†å‡ ä½•æ ·å¼
% ---------------------------------------------------------
\tikzset{
    % å‘é‡ç®­å¤´
    vector/.style={
        ->,
        >=Stealth,
        thick,
        draw=mf@thm@blue
    },
    % åˆ‡å‘é‡
    tangent vector/.style={
        vector,
        draw=mf@cor@orange
    },
    % æ³•å‘é‡
    normal vector/.style={
        vector,
        draw=mf@prop@purple
    },
    % æµçº¿
    streamline/.style={
        thick,
        draw=mf@def@green,
        decoration={markings, mark=at position 0.5 with {\arrow{>}}},
        postaction={decorate}
    },
}

% === å‘é‡åœºç»˜åˆ¶å‘½ä»¤ ===
% ç”¨æ³•: \vectorfield{xèµ·ç‚¹}{yèµ·ç‚¹}{è¡Œæ•°}{åˆ—æ•°}{ç¼©æ”¾}
\newcommand{\vectorfield}[5]{
    \foreach \i in {0,...,#3} {
        \foreach \j in {0,...,#4} {
            \pgfmathsetmacro{\vx}{0.3*cos(\i*30+\j*20)}
            \pgfmathsetmacro{\vy}{0.3*sin(\i*20+\j*30)}
            \draw[vector, scale=#5] 
                ({#1+\i*0.8},{#2+\j*0.8}) -- ++(\vx,\vy);
        }
    }
}

% ---------------------------------------------------------
% [21.9] ç§‘å­¦ç»˜å›¾è¾…åŠ©å·¥å…·
% ---------------------------------------------------------

% === åæ ‡ç³»ç»˜åˆ¶ ===
\newcommand{\drawaxes}[4][]{
    \draw[->, >=Stealth, thick, #1] (#2,0) -- (#3,0) node[right] {$x$};
    \draw[->, >=Stealth, thick, #1] (0,#2) -- (0,#4) node[above] {$y$};
}

% === 3D åæ ‡ç³» ===
\newcommand{\drawaxesthree}[2][]{
    \draw[->, >=Stealth, thick, #1] (0,0,0) -- (#2,0,0) node[right] {$x$};
    \draw[->, >=Stealth, thick, #1] (0,0,0) -- (0,#2,0) node[above] {$y$};
    \draw[->, >=Stealth, thick, #1] (0,0,0) -- (0,0,#2) node[below left] {$z$};
}

% === ç½‘æ ¼ç»˜åˆ¶ ===
\newcommand{\drawgrid}[5][gray!30]{
    \draw[step=#5, #1, thin] (#2,#3) grid (#4-0.01,#4-0.01);
}

% === å‡½æ•°æ›²çº¿æ ·å¼ ===
\tikzset{
    function curve/.style={
        thick,
        draw=mf@thm@blue,
        smooth,
        samples=100
    },
    parametric curve/.style={
        thick,
        draw=mf@prop@purple,
        smooth,
        samples=100
    },
}

% === åŒºåŸŸå¡«å……æ ·å¼ ===
\tikzset{
    region fill/.style={
        fill=mf@thm@blue!15,
        draw=mf@thm@blue,
        thick
    },
    integral region/.style={
        pattern=north east lines,
        pattern color=mf@cor@orange!50
    },
}

% === ç­‰é«˜çº¿æ ·å¼ ===
\tikzset{
    contour/.style={
        draw=mf@def@green,
        thick
    },
    level set/.style={
        contour,
        dashed
    },
}

% === å¥‡ç‚¹æ ‡è®° ===
\tikzset{
    singularity/.style={
        circle,
        fill=red,
        inner sep=2pt
    },
    saddle point/.style={
        diamond,
        fill=mf@cor@orange,
        inner sep=2pt
    },
    source/.style={
        circle,
        draw=mf@def@green,
        fill=mf@def@green!30,
        inner sep=2pt
    },
    sink/.style={
        circle,
        draw=mf@prop@purple,
        fill=mf@prop@purple!30,
        inner sep=2pt
    },
}

% === æµ‹åœ°çº¿æ ·å¼ ===
\tikzset{
    geodesic/.style={
        thick,
        draw=mf@cor@orange,
        decoration={markings, mark=at position 0.3 with {\arrow{>}}, mark=at position 0.7 with {\arrow{>}}},
        postaction={decorate}
    },
}

% ---------------------------------------------------------
% [21.10] å¤å·è½´ (Papyrus) è£…é¥°ç¯å¢ƒ
% ---------------------------------------------------------
% ğŸ’¡ åˆ›å»ºç±»ä¼¼å¤è€ç¾Šçš®çº¸å·è½´æ•ˆæœçš„æ–‡æœ¬æ¡†

\pgfdeclarelayer{mf@papyrus@bg}
\pgfsetlayers{mf@papyrus@bg,main}

\tikzset{
    papyrus line/.style={ line width=1pt, draw=mf@ex@brown }
}

% å†…éƒ¨å‘½ä»¤: ç»˜åˆ¶å·è½´è¾¹ç¼˜
\def\mf@drawRole#1#2#3{%
    \begin{scope}[yscale=#2,scale=0.6*#3]
        \draw[papyrus line] (A.#1 west) .. controls +(0,1) and +(0,1) .. +(-1,0) 
            .. controls +(0,-1) and +(0,-1) .. +(-.2,0) 
            .. controls +(0,.7) and +(0,.7) .. +(-.8,0) 
            .. controls +(0,-.5) and +(0,-.5) .. +(-.5,0) -- +(-.2,0);
        \draw[papyrus line] (A.#1 west) +(-.6,-.75) -- +(0,-.75);
        \draw[papyrus line] (A.#1 west) +(-.65,-.375) -- +(-.25,-.375);
        \draw[papyrus line] (A.#1 east) .. controls +(0,.7) and +(.4,0) .. +(-.5,0.751) 
            -- ($(A.#1 west)+(-.5,.751)$);
    \end{scope}
}

% ç”¨æ³•: \papyrus[ç¼©æ”¾]{å†…å®¹}
\newcommand\papyrus[2][1]{%
    \tikz{
        \node[inner xsep=1em, inner ysep=0.5em] (A) {#2};
        \begin{pgfonlayer}{mf@papyrus@bg}
            \mf@drawRole{north}{1}{#1}
            \mf@drawRole{south}{-1}{#1}
            \draw[papyrus line] (A.north east) -- (A.south east);
            \draw[papyrus line] (A.south west) -- (A.north west);
        \end{pgfonlayer}
    }
}

% papyrus ç¯å¢ƒç‰ˆæœ¬
\newenvironment{papyrusbox}[1][1]{%
    \begin{center}
    \papyrus[#1]\bgroup
}{%
    \egroup
    \end{center}
}

% ---------------------------------------------------------
% [21.11] å…¬å¼æ³¨é‡Š/è§£è¯»ç³»ç»Ÿ (Formula Annotation)
% ---------------------------------------------------------
% ğŸ’¡ ç”¨äºç»™æ•°å­¦å…¬å¼æ·»åŠ å¸¦ç®­å¤´çš„è§£é‡Šè¯´æ˜

\tikzset{
    % å…¬å¼æ³¨é‡Šæ¡†æ ·å¼
    formula box/.style={
        rectangle,
        draw=mf@thm@blue,
        fill=mf@thm@blue!10,
        rounded corners=3pt,
        minimum height=2em,
        text centered,
        thick,
        font=\small
    },
    % å…¬å¼ä¸»æ¡† (çªå‡ºæ˜¾ç¤º)
    formula main/.style={
        rectangle,
        draw=mf@cor@orange,
        fill=mf@cor@orange!10,
        rounded corners=3pt,
        minimum height=2.5em,
        text centered,
        thick,
        font=\normalsize
    },
    % å…¬å¼è¯´æ˜æ¡† 
    formula note/.style={
        rectangle,
        draw=mf@def@green,
        fill=mf@def@green!8,
        rounded corners=2pt,
        minimum height=1.5em,
        text centered,
        font=\footnotesize,
        thick
    },
    % å…¬å¼é¡¹é«˜äº®
    formula term/.style={
        rectangle,
        draw=#1,
        fill=#1!20,
        rounded corners=3pt,
        minimum height=2em,
        inner sep=0.5em,
        thick,
        font=\large
    },
    formula term/.default=mf@thm@blue,
    % æ³¨é‡Šç®­å¤´
    formula arrow/.style={
        draw,
        -Stealth,
        thick,
        #1
    },
    formula arrow/.default=gray!70,
    % è™šçº¿æ³¨é‡Šç®­å¤´
    formula arrow dashed/.style={
        draw,
        -Stealth,
        thick,
        dashed,
        #1
    },
    formula arrow dashed/.default=gray!50,
}

% === å…¬å¼æµç¨‹å›¾æ ·å¼ (Kohn-Sham é£æ ¼) ===
\tikzset{
    % æµç¨‹æ­¥éª¤æ¡†
    ks box/.style={
        rectangle,
        draw=gray!50,
        fill=DarkGray!20,
        rounded corners=3pt,
        minimum height=2em,
        text width=15em,
        text centered,
        thick
    },
    % è¾“å…¥æ¡† 
    ks input/.style={
        ks box,
        fill=orange!20,
        text width=18em
    },
    % è¾“å‡ºæ¡†
    ks output/.style={
        ks box,
        fill=blue!20,
        text width=18em
    },
    % åˆ¤æ–­æ¡†
    ks decision/.style={
        ks box,
        fill=yellow!20
    },
    % å¾ªç¯æ ‡è®°
    ks loop/.style={
        rectangle,
        draw=gray!60,
        dashed,
        inner sep=1em,
        rounded corners=5pt
    },
    % æµç¨‹ç®­å¤´
    ks arrow/.style={
        draw,
        -Stealth,
        thick
    },
}

% === å…¬å¼ç»„ä»¶è§£é‡Šå›¾ (å¤šé¡¹å¼åˆ†è§£é£æ ¼) ===
\tikzset{
    % å…¬å¼ç»„ä»¶æ¡† (å¯è‡ªå®šä¹‰é¢œè‰²)
    eq part/.style={
        rectangle,
        draw,
        fill=#1!30,
        rounded corners=3pt,
        minimum height=3em,
        inner sep=0.5em,
        thick,
        font=\Large
    },
    eq part/.default=gray,
    % è¿ç®—ç¬¦
    eq operator/.style={
        font=\Huge,
        inner sep=0.3em
    },
    % è¯´æ˜æ ‡ç­¾
    eq label/.style={
        align=left,
        font=\normalsize,
        text width=12em
    },
    % è¯´æ˜ç®­å¤´
    eq arrow/.style={
        draw,
        -Stealth,
        ultra thick,
        #1
    },
    eq arrow/.default=gray!70,
}

% === å¿«æ·å‘½ä»¤ ===

% åˆ›å»ºå¸¦æ³¨é‡Šçš„å…¬å¼é¡¹
% ç”¨æ³•: \eqitem[é¢œè‰²]{å…¬å¼}{æ ‡ç­¾ä½ç½®}{è¯´æ˜æ–‡å­—}
\newcommand{\eqitem}[4][mf@thm@blue]{%
    \node[eq part=#1] (#2-box) {$#2$};
    \node[eq label, #3=of #2-box] (#2-label) {#4};
    \draw[eq arrow] (#2-label) -- (#2-box);
}

% å…¬å¼è§£è¯»ç¯å¢ƒ
% ç”¨æ³•: \begin{formulaexplain}[node distance] ... \end{formulaexplain}
\newenvironment{formulaexplain}[1][1.5cm]{%
    \begin{center}
    \begin{tikzpicture}[node distance=#1]
}{%
    \end{tikzpicture}
    \end{center}
}

% å…¬å¼æµç¨‹å›¾ç¯å¢ƒ
\newenvironment{formulaflow}[1][0.5cm]{%
    \begin{center}
    \begin{tikzpicture}[node distance=#1]
}{%
    \end{tikzpicture}
    \end{center}
}

% ---------------------------------------------------------
% [21.13] è®¡ç®—æœºç§‘å­¦å¯è§†åŒ–æ ·å¼ (CS Visualization)
% ---------------------------------------------------------
% ğŸ’¡ å±‚æ¬¡ç»“æ„å›¾/Hasseå›¾/ç±»ç»§æ‰¿å›¾/è´è¶ç½‘ç»œ/æ•°æ®ç»“æ„

\usetikzlibrary{shapes.multipart, shadows.blur}

% === é…è‰²å®šä¹‰ ===
\definecolor{cs@blue}{RGB}{70,130,180}
\definecolor{cs@green}{RGB}{60,179,113}
\definecolor{cs@orange}{RGB}{255,140,0}
\definecolor{cs@purple}{RGB}{147,112,219}
\definecolor{cs@red}{RGB}{220,80,80}
\definecolor{cs@gray}{RGB}{128,128,128}

% === å±‚æ¬¡ç»“æ„å›¾/Hasseå›¾æ ·å¼ ===
\tikzset{
    % å±‚æ¬¡ç»“æ„èŠ‚ç‚¹ (å¸¦é˜´å½±)
    hasse node/.style={
        thick,
        draw=cs@blue!80!black,
        fill=cs@blue!15,
        rounded corners=2pt,
        blur shadow={shadow blur steps=20, shadow xshift=1pt, shadow yshift=-1pt},
        minimum width=2cm,
        minimum height=0.8cm,
        font=\small,
        align=center
    },
    % æŠ½è±¡ç±»èŠ‚ç‚¹
    abstract node/.style={
        hasse node,
        draw=cs@purple!80!black,
        fill=cs@purple!15,
        font=\small\itshape
    },
    % æ¥å£èŠ‚ç‚¹
    interface node/.style={
        hasse node,
        draw=cs@green!80!black,
        fill=cs@green!15,
        dashed
    },
    % å…·ä½“ç±»èŠ‚ç‚¹
    concrete node/.style={
        hasse node,
        draw=cs@blue!80!black,
        fill=cs@blue!20
    },
    % å±‚æ¬¡è¿æ¥çº¿
    hasse edge/.style={
        thick,
        draw=cs@gray
    },
    % ç»§æ‰¿ç®­å¤´
    inherit arrow/.style={
        ->,
        >=Stealth,
        thick,
        draw=cs@gray
    },
    % å®ç°ç®­å¤´ (è™šçº¿)
    implement arrow/.style={
        ->,
        >=Stealth,
        thick,
        dashed,
        draw=cs@green!70!black
    },
}

% === UML ç±»å›¾æ ·å¼ ===
\tikzset{
    % UML ç±»æ¡†
    uml class/.style={
        rectangle split,
        rectangle split parts=3,
        draw=cs@blue!80!black,
        fill=white,
        thick,
        font=\small,
        align=left,
        minimum width=3cm
    },
    % UML æŠ½è±¡ç±»
    uml abstract/.style={
        uml class,
        draw=cs@purple!80!black,
        rectangle split part fill={cs@purple!20, white, white}
    },
    % UML æ¥å£
    uml interface/.style={
        uml class,
        draw=cs@green!80!black,
        dashed,
        rectangle split part fill={cs@green!15, white, white}
    },
    % èšåˆå…³ç³»
    aggregation/.style={
        ->,
        >=Diamond[open],
        thick
    },
    % ç»„åˆå…³ç³»
    composition/.style={
        ->,
        >=Diamond[fill=black],
        thick
    },
    % ä¾èµ–å…³ç³»
    dependency/.style={
        ->,
        >=Stealth,
        dashed,
        thick
    },
}

% === è´è¶ç½‘ç»œ/æ•°æ®æµå›¾æ ·å¼ ===
\tikzset{
    % æ•°æ®èŠ‚ç‚¹ (è´è¶ç½‘ç»œ)
    bf node/.style={
        rectangle,
        draw=cs@blue!80!black,
        fill=cs@blue!10,
        minimum width=1.5cm,
        minimum height=0.5cm,
        font=\footnotesize,
        align=center
    },
    % è´è¶æ“ä½œèŠ‚ç‚¹ (äº¤å‰ç‚¹)
    bf op/.style={
        circle,
        draw=cs@orange!80!black,
        fill=cs@orange!30,
        inner sep=2pt,
        font=\tiny
    },
    % æ•°æ®æµè¾¹
    bf edge/.style={
        thick,
        draw=cs@gray!70
    },
    % äº¤å‰æ•°æ®æµ
    bf cross/.style={
        thick,
        draw=cs@red!70
    },
    % é˜¶æ®µåˆ†å‰²çº¿
    stage line/.style={
        dashed,
        draw=cs@gray!50
    },
}

% === æ•°æ®ç»“æ„å¯è§†åŒ–æ ·å¼ ===
\tikzset{
    % æ•°ç»„å•å…ƒæ ¼
    array cell/.style={
        rectangle,
        draw=cs@blue!80!black,
        fill=cs@blue!10,
        minimum width=1cm,
        minimum height=0.8cm,
        font=\small,
        anchor=west
    },
    % æ•°ç»„ç´¢å¼•æ ‡ç­¾
    array index/.style={
        font=\tiny,
        text=cs@gray
    },
    % é“¾è¡¨èŠ‚ç‚¹
    list node/.style={
        rectangle split,
        rectangle split parts=2,
        rectangle split horizontal,
        draw=cs@green!80!black,
        fill=cs@green!10,
        minimum height=0.8cm,
        font=\small
    },
    % é“¾è¡¨æŒ‡é’ˆ
    list pointer/.style={
        ->,
        >=Stealth,
        thick,
        draw=cs@gray
    },
    % äºŒå‰æ ‘èŠ‚ç‚¹
    tree node/.style={
        circle,
        draw=cs@purple!80!black,
        fill=cs@purple!15,
        minimum size=0.8cm,
        font=\small
    },
    % æ ‘è¾¹
    tree edge/.style={
        thick,
        draw=cs@gray
    },
    % ç©ºèŠ‚ç‚¹ (NULL)
    null node/.style={
        rectangle,
        draw=cs@gray,
        fill=cs@gray!20,
        minimum width=0.5cm,
        minimum height=0.3cm,
        font=\tiny
    },
    % å †æ ˆå•å…ƒ
    stack cell/.style={
        rectangle,
        draw=cs@orange!80!black,
        fill=cs@orange!15,
        minimum width=2cm,
        minimum height=0.6cm,
        font=\small
    },
    % å †æ ˆæŒ‡é’ˆ
    stack pointer/.style={
        ->,
        >=Stealth,
        very thick,
        draw=cs@red
    },
}

% === å†…å­˜/å¯„å­˜å™¨å›¾æ ·å¼ ===
\tikzset{
    % å†…å­˜å—
    memory block/.style={
        rectangle,
        draw=cs@blue!80!black,
        fill=cs@blue!8,
        minimum width=3cm,
        minimum height=0.6cm,
        font=\footnotesize\ttfamily,
        anchor=north
    },
    % åœ°å€æ ‡ç­¾
    address label/.style={
        font=\tiny\ttfamily,
        text=cs@gray,
        anchor=east
    },
    % å¯„å­˜å™¨
    register/.style={
        rectangle,
        draw=cs@orange!80!black,
        fill=cs@orange!15,
        minimum width=2cm,
        minimum height=0.5cm,
        font=\small\ttfamily
    },
    % ä½åŸŸ
    bitfield/.style={
        rectangle split,
        rectangle split parts=8,
        rectangle split horizontal,
        draw=cs@purple!80!black,
        fill=cs@purple!10,
        font=\tiny\ttfamily
    },
}

% === æœ‰é™çŠ¶æ€æœºå¢å¼ºæ ·å¼ ===
\tikzset{
    % çŠ¶æ€ (åœ†è§’çŸ©å½¢)
    fsm state/.style={
        rectangle,
        rounded corners=5pt,
        draw=cs@blue!80!black,
        fill=cs@blue!15,
        minimum width=1.5cm,
        minimum height=0.8cm,
        font=\small,
        thick
    },
    % åˆå§‹çŠ¶æ€
    fsm initial/.style={
        fsm state,
        draw=cs@green!80!black,
        fill=cs@green!15
    },
    % ç»ˆæ­¢çŠ¶æ€
    fsm final/.style={
        fsm state,
        double,
        double distance=2pt,
        draw=cs@red!80!black,
        fill=cs@red!10
    },
    % çŠ¶æ€è½¬ç§»
    fsm trans/.style={
        ->,
        >=Stealth,
        thick,
        draw=cs@gray
    },
    % è½¬ç§»æ ‡ç­¾
    fsm label/.style={
        font=\footnotesize,
        fill=white,
        inner sep=1pt
    },
}

% === å¿«æ·ç»˜å›¾å‘½ä»¤ ===

% ç»˜åˆ¶æ•°ç»„
% ç”¨æ³•: \drawarray{èµ·å§‹x}{èµ·å§‹y}{å…ƒç´ åˆ—è¡¨}
\newcommand{\drawarray}[3]{%
    \foreach \elem [count=\i from 0] in {#3} {
        \node[array cell] at ({#1+\i*1cm}, #2) {\elem};
        \node[array index] at ({#1+\i*1cm+0.5cm}, {#2-0.6cm}) {\i};
    }
}

% ç»˜åˆ¶æ ˆ
% ç”¨æ³•: \drawstack{x}{y}{å…ƒç´ åˆ—è¡¨}
\newcommand{\drawstack}[3]{%
    \foreach \elem [count=\i from 0] in {#3} {
        \node[stack cell] at (#1, {#2+\i*0.7cm}) {\elem};
    }
    \draw[stack pointer] ({#1-1.5cm}, {#2+0.3cm}) -- ({#1-0.2cm}, {#2+0.3cm}) node[midway, above] {\tiny SP};
}

% å±‚æ¬¡ç»“æ„ç¯å¢ƒ
\newenvironment{hassediagram}[1][2cm]{%
    \begin{center}
    \begin{tikzpicture}[node distance=#1, >=Stealth]
}{%
    \end{tikzpicture}
    \end{center}
}

% è´è¶ç½‘ç»œç¯å¢ƒ
\newenvironment{butterflynet}[1][2cm]{%
    \begin{center}
    \begin{tikzpicture}[node distance=#1, line cap=round]
}{%
    \end{tikzpicture}
    \end{center}
}

% æ•°æ®ç»“æ„ç¯å¢ƒ
\newenvironment{datastructure}[1][1cm]{%
    \begin{center}
    \begin{tikzpicture}[node distance=#1]
}{%
    \end{tikzpicture}
    \end{center}
}

% ---------------------------------------------------------
% [21.15] åŒ–å­¦ä¸ç‰©ç†å¯è§†åŒ–æ ·å¼ (Chemistry & Physics)
% ---------------------------------------------------------
% ğŸ’¡ å…ƒç´ å‘¨æœŸè¡¨/ç²’å­ç‰©ç†æ ‡å‡†æ¨¡å‹/åˆ†å­ç»“æ„/èƒ½çº§å›¾

% === å…ƒç´ å‘¨æœŸè¡¨é…è‰² ===
\definecolor{chem@alkali}{RGB}{255,102,102}       % ç¢±é‡‘å±
\definecolor{chem@alkaline}{RGB}{255,222,173}     % ç¢±åœŸé‡‘å±
\definecolor{chem@transition}{RGB}{255,192,203}   % è¿‡æ¸¡é‡‘å±
\definecolor{chem@metal}{RGB}{204,204,255}        % å…¶ä»–é‡‘å±
\definecolor{chem@metalloid}{RGB}{204,255,204}    % ç±»é‡‘å±
\definecolor{chem@nonmetal}{RGB}{160,255,160}     % éé‡‘å±
\definecolor{chem@halogen}{RGB}{255,255,153}      % å¤ç´ 
\definecolor{chem@noble}{RGB}{192,255,255}        % ç¨€æœ‰æ°”ä½“
\definecolor{chem@lanthanide}{RGB}{255,191,255}   % é•§ç³»
\definecolor{chem@actinide}{RGB}{255,153,204}     % é”•ç³»

% === ç²’å­ç‰©ç†é…è‰² ===
\definecolor{phys@quark}{RGB}{170,130,255}        % å¤¸å…‹
\definecolor{phys@lepton}{RGB}{130,200,130}       % è½»å­
\definecolor{phys@gauge}{RGB}{255,120,120}        % è§„èŒƒç»è‰²å­
\definecolor{phys@scalar}{RGB}{255,200,100}       % æ ‡é‡ç»è‰²å­

% === å…ƒç´ å‘¨æœŸè¡¨æ ·å¼ ===
\tikzset{
    % åŸºç¡€å…ƒç´ æ¡†
    element/.style={
        rectangle,
        draw=black!70,
        thick,
        minimum width=2cm,
        minimum height=2cm,
        font=\sffamily,
        align=center
    },
    % ç¢±é‡‘å±
    alkali metal/.style={
        element,
        fill=chem@alkali!60
    },
    % ç¢±åœŸé‡‘å±
    alkaline earth/.style={
        element,
        fill=chem@alkaline!70
    },
    % è¿‡æ¸¡é‡‘å±
    transition metal/.style={
        element,
        fill=chem@transition!60
    },
    % å…¶ä»–é‡‘å±
    post-transition/.style={
        element,
        fill=chem@metal!60
    },
    % ç±»é‡‘å±
    metalloid/.style={
        element,
        fill=chem@metalloid!70
    },
    % éé‡‘å±
    nonmetal/.style={
        element,
        fill=chem@nonmetal!70
    },
    % å¤ç´ 
    halogen/.style={
        element,
        fill=chem@halogen!80
    },
    % ç¨€æœ‰æ°”ä½“
    noble gas/.style={
        element,
        fill=chem@noble!70
    },
    % é•§ç³»
    lanthanide/.style={
        element,
        fill=chem@lanthanide!60
    },
    % é”•ç³»
    actinide/.style={
        element,
        fill=chem@actinide!60
    },
}

% === ç²’å­ç‰©ç†æ ‡å‡†æ¨¡å‹æ ·å¼ ===
\tikzset{
    % ç²’å­åŸºç¡€æ¡†
    particle box/.style={
        rectangle,
        draw=black!50,
        thick,
        rounded corners=3pt,
        minimum width=1.8cm,
        minimum height=1.8cm,
        font=\sffamily,
        align=center,
        drop shadow={shadow xshift=1pt, shadow yshift=-1pt, opacity=0.3}
    },
    % å¤¸å…‹
    quark/.style={
        particle box,
        top color=phys@quark!40,
        bottom color=phys@quark!70
    },
    % è½»å­
    lepton/.style={
        particle box,
        top color=phys@lepton!40,
        bottom color=phys@lepton!70
    },
    % è§„èŒƒç»è‰²å­
    gauge boson/.style={
        particle box,
        top color=phys@gauge!40,
        bottom color=phys@gauge!70
    },
    % æ ‡é‡ç»è‰²å­ (Higgs)
    scalar boson/.style={
        particle box,
        top color=phys@scalar!50,
        bottom color=phys@scalar!80
    },
    % ç²’å­åˆ†ç»„æ¡†
    particle group/.style={
        draw=black!30,
        fill=black!5,
        rounded corners=5pt,
        inner sep=0.5em
    },
}

% === åˆ†å­ç»“æ„æ ·å¼ ===
\tikzset{
    % åŸå­èŠ‚ç‚¹
    atom/.style={
        circle,
        draw=black!70,
        thick,
        minimum size=1cm,
        font=\sffamily\bfseries,
        align=center
    },
    % ç¢³åŸå­
    carbon/.style={
        atom,
        fill=black!20
    },
    % æ°¢åŸå­
    hydrogen/.style={
        atom,
        fill=white,
        minimum size=0.6cm
    },
    % æ°§åŸå­
    oxygen/.style={
        atom,
        fill=red!30
    },
    % æ°®åŸå­
    nitrogen/.style={
        atom,
        fill=blue!30
    },
    % ç¡«åŸå­
    sulfur/.style={
        atom,
        fill=yellow!50
    },
    % ç£·åŸå­
    phosphorus/.style={
        atom,
        fill=orange!40
    },
    % å•é”®
    single bond/.style={
        thick,
        draw=black!70
    },
    % åŒé”®
    double bond/.style={
        thick,
        draw=black!70,
        double,
        double distance=2pt
    },
    % ä¸‰é”®
    triple bond/.style={
        thick,
        draw=black!70,
        double,
        double distance=3pt,
        postaction={draw=black!70, thick}
    },
    % è™šé”® (æ°¢é”®ç­‰)
    dashed bond/.style={
        thick,
        dashed,
        draw=black!50
    },
    % æ¥”å½¢é”® (ç«‹ä½“åŒ–å­¦)
    wedge bond/.style={
        -Triangle[length=8pt, width=6pt],
        thick,
        draw=black!70,
        fill=black!70
    },
    % è™šæ¥”å½¢é”®
    hashed bond/.style={
        thick,
        draw=black!70,
        decorate,
        decoration={ticks, segment length=2pt, amplitude=3pt}
    },
}

% === èƒ½çº§å›¾æ ·å¼ ===
\tikzset{
    % èƒ½çº§çº¿
    energy level/.style={
        thick,
        draw=cs@blue!80!black
    },
    % åŸºæ€
    ground state/.style={
        energy level,
        draw=cs@green!80!black
    },
    % æ¿€å‘æ€
    excited state/.style={
        energy level,
        draw=cs@red!80!black
    },
    % èƒ½çº§è·ƒè¿ç®­å¤´
    transition arrow/.style={
        ->,
        >=Stealth,
        thick,
        draw=cs@orange,
        decorate,
        decoration={snake, amplitude=1mm, segment length=3mm, post length=2mm}
    },
    % èƒ½çº§æ ‡ç­¾
    energy label/.style={
        font=\small,
        anchor=west
    },
}

% === åŒ–å­¦ååº”å›¾æ ·å¼ ===
\tikzset{
    % ååº”ç‰©/äº§ç‰©æ¡†
    reactant/.style={
        rectangle,
        draw=cs@blue!70,
        fill=cs@blue!10,
        rounded corners=3pt,
        minimum height=1.5em,
        inner sep=0.5em,
        font=\large
    },
    product/.style={
        rectangle,
        draw=cs@green!70,
        fill=cs@green!10,
        rounded corners=3pt,
        minimum height=1.5em,
        inner sep=0.5em,
        font=\large
    },
    % ååº”ç®­å¤´
    reaction arrow/.style={
        ->,
        >=Stealth,
        very thick,
        draw=black!70
    },
    % å¯é€†ååº”ç®­å¤´
    reversible arrow/.style={
        <->,
        >=Stealth,
        very thick,
        draw=black!70
    },
    % å‚¬åŒ–å‰‚æ ‡ç­¾
    catalyst/.style={
        font=\footnotesize,
        above,
        text=cs@orange!80!black
    },
    % ååº”æ¡ä»¶æ ‡ç­¾
    condition/.style={
        font=\footnotesize,
        below,
        text=cs@gray
    },
}

% === å¿«æ·å‘½ä»¤ ===

% ç»˜åˆ¶å…ƒç´ 
% ç”¨æ³•: \drawelement[æ ·å¼]{ç¬¦å·}{åŸå­åºæ•°}{åç§°}{ç›¸å¯¹åŸå­è´¨é‡}
\newcommand{\drawelement}[5][element]{%
    \node[#1] {%
        \begin{minipage}{1.8cm}
            \centering
            {\footnotesize #3} \hfill {\footnotesize #5}\\[2pt]
            {\Huge\bfseries #2}\\[2pt]
            {\small #4}
        \end{minipage}
    }
}

% ç»˜åˆ¶ç²’å­
% ç”¨æ³•: \drawparticle[æ ·å¼]{ç¬¦å·}{åç§°}{è´¨é‡}{ç”µè·}{è‡ªæ—‹}
\newcommand{\drawparticle}[6][particle box]{%
    \node[#1] {%
        \begin{minipage}{1.5cm}
            \centering
            {\tiny #4}\\[-2pt]
            {\Large\bfseries #2}\\[-2pt]
            {\scriptsize #3}\\[-3pt]
            {\tiny Q=#5, S=#6}
        \end{minipage}
    }
}

% å…ƒç´ å‘¨æœŸè¡¨ç¯å¢ƒ
\newenvironment{periodictable}[1][0.4]{%
    \begin{center}
    \begin{tikzpicture}[scale=#1, every node/.style={transform shape}]
}{%
    \end{tikzpicture}
    \end{center}
}

% åˆ†å­ç»“æ„ç¯å¢ƒ
\newenvironment{molecule}[1][1cm]{%
    \begin{center}
    \begin{tikzpicture}[node distance=#1]
}{%
    \end{tikzpicture}
    \end{center}
}

% èƒ½çº§å›¾ç¯å¢ƒ
\newenvironment{energydiagram}[1][1cm]{%
    \begin{center}
    \begin{tikzpicture}[node distance=#1]
}{%
    \end{tikzpicture}
    \end{center}
}

% ---------------------------------------------------------
% [21.17] é«˜çº§æ•°å­¦æµç¨‹å›¾æ ·å¼ (Advanced Math Flowcharts)
% ---------------------------------------------------------
% ğŸ’¡ DMFTå¾ªç¯å›¾/ç§‘å­¦è®¡ç®—æµç¨‹/ç ”ç©¶å·¥ä½œæµ

% === é…è‰²å®šä¹‰ ===
\definecolor{flow@blue}{RGB}{70,130,180}
\definecolor{flow@green}{RGB}{60,179,113}
\definecolor{flow@red}{RGB}{220,80,80}
\definecolor{flow@purple}{RGB}{147,112,219}
\definecolor{flow@orange}{RGB}{255,140,0}
\definecolor{flow@cyan}{RGB}{0,180,180}

% === DMFT é£æ ¼åˆ†ç»„æ¡†æ ·å¼ ===
\tikzset{
    % åŸºç¡€åˆ†ç»„æ¡†
    basic box/.style={
        shape=rectangle,
        rounded corners=8pt,
        align=center,
        draw=#1!80!black,
        fill=#1!20,
        thick,
        inner sep=1em
    },
    basic box/.default=flow@blue,
    % å¸¦æ ‡é¢˜æ ·å¼ (ä½¿ç”¨label)
    with header/.style={
        label={[
            fill=white,
            draw=gray!60,
            thick,
            font=\bfseries\ttfamily,
            inner sep=0.3em,
            anchor=south
        ]north:#1}
    },
    with header/.default={Title},
    % å¾ªç¯æ¡† (DMFT loop style)
    loop box/.style={
        basic box=flow@blue,
        minimum width=8cm,
        minimum height=4cm
    },
    % å‰ç½®æ¡†
    prelude box/.style={
        basic box=flow@green,
        minimum width=4cm
    },
    % æ›´æ–°æ¡†
    update box/.style={
        basic box=flow@orange,
        minimum width=3cm
    },
    % è®¡ç®—æ¡†
    compute box/.style={
        basic box=flow@purple,
        minimum width=4cm
    },
}

% === ç§‘å­¦è®¡ç®—æµç¨‹æ ·å¼ ===
\tikzset{
    % è¾“å…¥/è¾“å‡ºèŠ‚ç‚¹
    sci input/.style={
        rectangle,
        draw=flow@green!80!black,
        fill=flow@green!25,
        rounded corners=3pt,
        minimum height=1.5em,
        minimum width=3cm,
        font=\small,
        thick
    },
    sci output/.style={
        rectangle,
        draw=flow@red!80!black,
        fill=flow@red!25,
        rounded corners=3pt,
        minimum height=1.5em,
        minimum width=3cm,
        font=\small,
        thick
    },
    % è®¡ç®—æ­¥éª¤
    sci step/.style={
        rectangle,
        draw=flow@blue!80!black,
        fill=flow@blue!15,
        minimum height=2em,
        minimum width=4cm,
        font=\small,
        thick
    },
    % åˆ¤æ–­èŠ‚ç‚¹
    sci decision/.style={
        diamond,
        draw=flow@orange!80!black,
        fill=flow@orange!20,
        minimum width=2cm,
        minimum height=2cm,
        font=\small,
        thick,
        aspect=2
    },
    % å¾ªç¯æ ‡è®°
    sci loop/.style={
        rectangle,
        draw=flow@purple!80!black,
        fill=flow@purple!15,
        dashed,
        rounded corners=5pt,
        inner sep=1em
    },
    % ç²—è“çº¿
    fat blue line/.style={
        ultra thick,
        flow@blue
    },
    % æµç¨‹ç®­å¤´
    sci arrow/.style={
        ->,
        >=Stealth,
        thick,
        draw=gray!70
    },
    % æ­£äº¤è·¯å¾„ç®­å¤´
    ortho arrow/.style={
        ->,
        >=Stealth,
        thick,
        draw=gray!70,
        rounded corners=3pt
    },
}

% === è¿­ä»£ç®—æ³•æ ·å¼ ===
\tikzset{
    % åˆå§‹åŒ–
    iter init/.style={
        rectangle,
        draw=flow@green!80!black,
        fill=flow@green!20,
        rounded corners=5pt,
        minimum height=2em,
        minimum width=5cm,
        font=\small
    },
    % è¿­ä»£æ­¥éª¤
    iter step/.style={
        rectangle,
        draw=flow@blue!80!black,
        fill=flow@blue!15,
        minimum height=2em,
        minimum width=5cm,
        font=\small
    },
    % æ”¶æ•›åˆ¤æ–­
    iter converge/.style={
        diamond,
        draw=flow@orange!80!black,
        fill=flow@orange!15,
        minimum width=3cm,
        aspect=2.5,
        font=\small
    },
    % è¾“å‡ºç»“æœ
    iter result/.style={
        rectangle,
        draw=flow@red!80!black,
        fill=flow@red!15,
        rounded corners=5pt,
        minimum height=2em,
        minimum width=5cm,
        font=\small
    },
    % å¾ªç¯ç®­å¤´
    iter loop/.style={
        ->,
        >=Stealth,
        thick,
        draw=flow@purple,
        looseness=1.5
    },
}

% === ç ”ç©¶å·¥ä½œæµæ ·å¼ ===
\tikzset{
    % é˜¶æ®µæ¡†
    phase box/.style={
        rectangle,
        draw=#1!80!black,
        fill=#1!20,
        rounded corners=10pt,
        minimum height=3em,
        minimum width=4cm,
        font=\bfseries,
        thick
    },
    phase box/.default=flow@blue,
    % é˜¶æ®µè¿æ¥
    phase arrow/.style={
        ->,
        >=Stealth,
        very thick,
        draw=gray!60
    },
    % é‡Œç¨‹ç¢‘
    milestone/.style={
        star,
        star points=5,
        star point ratio=2,
        draw=flow@orange!80!black,
        fill=flow@orange!40,
        minimum size=1cm,
        font=\small\bfseries
    },
    % æ•°æ®æµ
    data flow/.style={
        ->,
        >=Stealth,
        thick,
        dashed,
        draw=flow@cyan
    },
    % åé¦ˆå¾ªç¯
    feedback loop/.style={
        ->,
        >=Stealth,
        thick,
        draw=flow@purple,
        bend left=60
    },
}

% === 3D å¤šé‡æ€å›¾æ ·å¼ ===
\tikzset{
    % ç²’å­çƒ
    particle ball/.style={
        shading=ball,
        ball color=white!80!black,
        circle,
        minimum size=0.8cm,
        font=\small
    },
    % å±‚é¢å¡«å……
    level plane/.style={
        fill=gray!20,
        draw=gray!50,
        opacity=0.7
    },
    % è¿æ¥çº¿
    multiplet edge/.style={
        thick,
        draw=gray!60
    },
    multiplet edge dashed/.style={
        thick,
        dashed,
        draw=gray!40
    },
    % åæ ‡è½´
    axis3d/.style={
        ->,
        >=Stealth,
        thick,
        draw=black
    },
    axis label/.style={
        font=\small
    },
}

% === å¿«æ·å‘½ä»¤ ===

% åˆ›å»ºå¸¦æ ‡é¢˜çš„åˆ†ç»„æ¡†
% ç”¨æ³•: \headerbox[é¢œè‰²]{æ ‡é¢˜}{å†…å®¹å®½åº¦}{å†…å®¹é«˜åº¦}
\newcommand{\headerbox}[4][flow@blue]{%
    \node[basic box=#1, minimum width=#3, minimum height=#4] (box) {};
    \node[fill=white, draw=#1!80!black, thick, font=\bfseries\ttfamily, 
          inner sep=0.3em] at (box.north) {#2};
}

% ç§‘å­¦æµç¨‹å›¾ç¯å¢ƒ
\newenvironment{sciflow}[1][1.5cm]{%
    \begin{center}
    \begin{tikzpicture}[node distance=#1, >=Stealth, thick]
}{%
    \end{tikzpicture}
    \end{center}
}

% è¿­ä»£ç®—æ³•ç¯å¢ƒ  
\newenvironment{iterflow}[1][1.2cm]{%
    \begin{center}
    \begin{tikzpicture}[node distance=#1, >=Stealth]
}{%
    \end{tikzpicture}
    \end{center}
}

% ç ”ç©¶å·¥ä½œæµç¯å¢ƒ
\newenvironment{workflow}[1][2cm]{%
    \begin{center}
    \begin{tikzpicture}[node distance=#1, >=Stealth]
}{%
    \end{tikzpicture}
    \end{center}
}

% ---------------------------------------------------------
% [21.19] 3D å‡ ä½•å›¾å½¢æ ·å¼ (3D Geometry Visualization)
% ---------------------------------------------------------
% ğŸ’¡ å¤šé¢ä½“/æ–œå¤šè¾¹å½¢/æ›²é¢/åæ ‡ç³»

% === 3D é…è‰²å®šä¹‰ ===
\definecolor{geo3d@face}{RGB}{100,200,220}
\definecolor{geo3d@edge}{RGB}{200,80,80}
\definecolor{geo3d@vertex}{RGB}{80,80,200}
\definecolor{geo3d@hidden}{RGB}{150,150,150}
\definecolor{geo3d@surface}{RGB}{0,200,200}

% === å¤šé¢ä½“æ ·å¼ ===
\tikzset{
    % å¤šé¢ä½“é¢ (å¯è§)
    poly face/.style={
        thick,
        draw=geo3d@edge,
        fill=geo3d@face!35,
        opacity=0.75
    },
    % å¤šé¢ä½“é¢ (å¸¦è‡ªå®šä¹‰é¢œè‰²)
    poly face color/.style={
        thick,
        draw=geo3d@edge,
        fill=#1!35,
        opacity=0.75
    },
    poly face color/.default=geo3d@face,
    % å¤šé¢ä½“è¾¹ (å¯è§)
    poly edge/.style={
        thick,
        draw=geo3d@edge
    },
    % å¤šé¢ä½“è¾¹ (éšè—/è™šçº¿)
    poly edge hidden/.style={
        thick,
        dashed,
        draw=geo3d@hidden
    },
    % é¡¶ç‚¹
    poly vertex/.style={
        circle,
        fill=geo3d@vertex,
        inner sep=1.5pt
    },
    % é¡¶ç‚¹æ ‡ç­¾
    vertex label/.style={
        font=\small,
        text=black
    },
}

% === æ›²é¢/æ–œå¤šè¾¹å½¢æ ·å¼ ===
\tikzset{
    % æ›²é¢ç½‘æ ¼çº¿
    surface grid/.style={
        thin,
        draw=geo3d@surface,
        opacity=0.25
    },
    % æ›²é¢è¾¹ç•Œ
    surface boundary/.style={
        very thick,
        draw=geo3d@edge
    },
    % å‚æ•°æ›²é¢å¡«å……
    surface fill/.style={
        fill=geo3d@face!20,
        draw=none,
        opacity=0.5
    },
    % æ–œå¤šè¾¹å½¢è¾¹
    skew edge/.style={
        very thick,
        draw=geo3d@edge
    },
}

% === 3D åæ ‡ç³»æ ·å¼ ===
\tikzset{
    % åæ ‡è½´
    3d axis/.style={
        ->,
        >=Stealth,
        thick,
        draw=black
    },
    % åæ ‡è½´æ ‡ç­¾
    3d axis label/.style={
        font=\small
    },
    % è¾…åŠ©å¹³é¢
    aux plane/.style={
        fill=gray!10,
        draw=gray!30,
        opacity=0.3
    },
    % è¾…åŠ©çº¿
    aux line/.style={
        thin,
        dashed,
        draw=gray!50
    },
}

% === æ™¶ä½“å­¦/å¤šé¢ä½“ç‰¹æ®Šæ ·å¼ ===
\tikzset{
    % æ­£å¤šé¢ä½“é¢ (æŸæ‹‰å›¾ç«‹ä½“)
    platonic face/.style={
        thick,
        draw=geo3d@edge!80!black,
        fill=geo3d@face!40,
        opacity=0.8
    },
    % é˜¿åŸºç±³å¾·å¤šé¢ä½“é¢
    archimedean face/.style={
        thick,
        draw=geo3d@edge!70!black,
        fill=#1!30,
        opacity=0.75
    },
    archimedean face/.default=geo3d@face,
    % è±å½¢é¢
    rhombic face/.style={
        thick,
        draw=geo3d@edge,
        fill=cyan!35,
        opacity=0.75
    },
    % æ™¶æ ¼ç‚¹
    lattice point/.style={
        circle,
        fill=black,
        inner sep=1pt
    },
    % æ™¶æ ¼è¾¹
    lattice edge/.style={
        thin,
        draw=gray!60
    },
}

% === æŠ•å½±æ ·å¼ ===
\tikzset{
    % æŠ•å½±é¢
    projection plane/.style={
        fill=gray!5,
        draw=gray!40,
        opacity=0.5
    },
    % æŠ•å½±çº¿
    projection line/.style={
        thin,
        dashed,
        draw=gray!40
    },
    % æŠ•å½±ç‚¹
    projection point/.style={
        circle,
        fill=gray!60,
        inner sep=1pt
    },
}

% === å¿«æ·å‘½ä»¤ ===

% ç»˜åˆ¶ 3D åæ ‡è½´
% ç”¨æ³•: \drawaxes3d{xé•¿åº¦}{yé•¿åº¦}{zé•¿åº¦}
\newcommand{\drawaxesthreeD}[3]{%
    \draw[3d axis] (0,0,0) -- (#1,0,0) node[3d axis label, right] {$x$};
    \draw[3d axis] (0,0,0) -- (0,#2,0) node[3d axis label, above] {$y$};
    \draw[3d axis] (0,0,0) -- (0,0,#3) node[3d axis label, above] {$z$};
}

% ç»˜åˆ¶é•¿æ–¹ä½“æ¡†æ¶
% ç”¨æ³•: \drawbox{a}{b}{c} (ä¸‰è¾¹é•¿)
\newcommand{\drawcuboid}[3]{%
    % åº•é¢
    \draw[poly edge hidden] (0,0,0) -- (#1,0,0) -- (#1,#2,0) -- (0,#2,0) -- cycle;
    % é¡¶é¢
    \draw[poly edge] (0,0,#3) -- (#1,0,#3) -- (#1,#2,#3) -- (0,#2,#3) -- cycle;
    % å‚ç›´è¾¹
    \draw[poly edge hidden] (0,0,0) -- (0,0,#3);
    \draw[poly edge] (#1,0,0) -- (#1,0,#3);
    \draw[poly edge] (#1,#2,0) -- (#1,#2,#3);
    \draw[poly edge] (0,#2,0) -- (0,#2,#3);
}

% 3D å‡ ä½•ç¯å¢ƒ (ä½¿ç”¨ tikz-3dplot)
\newenvironment{geometry3d}[2][70]{%
    \begin{center}
    \tdplotsetmaincoords{#1}{#2}
    \begin{tikzpicture}[tdplot_main_coords, scale=1.5]
}{%
    \end{tikzpicture}
    \end{center}
}

% å¤šé¢ä½“ç¯å¢ƒ
\newenvironment{polyhedron}[2][80]{%
    \begin{center}
    \tdplotsetmaincoords{#1}{#2}
    \begin{tikzpicture}[tdplot_main_coords]
}{%
    \end{tikzpicture}
    \end{center}
}

% ---------------------------------------------------------
% [21.21] ç¥ç»ç½‘ç»œå¯è§†åŒ–æ ·å¼ (Neural Network Visualization)
% ---------------------------------------------------------
% ğŸ’¡ å…¨è¿æ¥ç½‘ç»œ/è‡ªç¼–ç å™¨/CNN/MADE/VAE

% === ç¥ç»ç½‘ç»œé…è‰² ===
\definecolor{nn@input}{RGB}{100,180,100}
\definecolor{nn@hidden}{RGB}{100,150,220}
\definecolor{nn@output}{RGB}{220,100,100}
\definecolor{nn@mu}{RGB}{255,220,100}
\definecolor{nn@sigma}{RGB}{100,150,255}
\definecolor{nn@sample}{RGB}{100,220,150}
\definecolor{nn@conv}{RGB}{180,130,220}
\definecolor{nn@pool}{RGB}{130,200,200}

% === ç¥ç»å…ƒæ ·å¼ ===
\tikzset{
    % åŸºç¡€ç¥ç»å…ƒ
    neuron/.style={
        circle,
        draw=black!70,
        thick,
        minimum size=4ex,
        font=\small
    },
    % è¾“å…¥å±‚ç¥ç»å…ƒ
    input neuron/.style={
        neuron,
        fill=nn@input!30
    },
    % éšè—å±‚ç¥ç»å…ƒ
    hidden neuron/.style={
        neuron,
        fill=nn@hidden!30
    },
    % è¾“å‡ºå±‚ç¥ç»å…ƒ
    output neuron/.style={
        neuron,
        fill=nn@output!30
    },
    % åç½®èŠ‚ç‚¹
    bias node/.style={
        neuron,
        fill=gray!20,
        font=\small\bfseries
    },
    % æ¿€æ´»å‡½æ•°æ ‡è®°
    activation/.style={
        font=\scriptsize,
        text=black!60
    },
}

% === è¿æ¥æ ·å¼ ===
\tikzset{
    % æ™®é€šè¿æ¥
    nn edge/.style={
        ->,
        >=Stealth,
        draw=gray!60,
        shorten >=1pt,
        shorten <=1pt
    },
    % æƒé‡è¿æ¥ (åŠ ç²—)
    weight edge/.style={
        nn edge,
        thick,
        draw=nn@hidden!70
    },
    % ç¨€ç–è¿æ¥
    sparse edge/.style={
        nn edge,
        draw=nn@hidden!50
    },
    % è·³è·ƒè¿æ¥ (æ®‹å·®)
    skip connection/.style={
        ->,
        >=Stealth,
        thick,
        draw=nn@output!70,
        dashed,
        bend left=40
    },
    % åå‘ä¼ æ’­
    backprop edge/.style={
        <-,
        >=Stealth,
        draw=red!50,
        dashed
    },
}

% === å±‚æ ·å¼ ===
\tikzset{
    % å±‚æ¡†
    layer box/.style={
        rectangle,
        draw=gray!50,
        fill=#1!10,
        rounded corners=5pt,
        minimum width=1.5cm,
        minimum height=3cm,
        thick
    },
    layer box/.default=nn@hidden,
    % å·ç§¯å±‚
    conv layer/.style={
        rectangle,
        draw=nn@conv!80!black,
        fill=nn@conv!25,
        minimum width=0.5cm,
        minimum height=2.5cm,
        thick
    },
    % æ± åŒ–å±‚
    pool layer/.style={
        rectangle,
        draw=nn@pool!80!black,
        fill=nn@pool!25,
        minimum width=0.3cm,
        minimum height=2cm,
        thick
    },
    % å…¨è¿æ¥å±‚
    fc layer/.style={
        rectangle,
        draw=nn@hidden!80!black,
        fill=nn@hidden!20,
        minimum width=0.8cm,
        minimum height=2.5cm,
        thick
    },
    % Dropoutå±‚
    dropout layer/.style={
        rectangle,
        draw=gray!60,
        fill=gray!10,
        dashed,
        minimum width=0.3cm,
        minimum height=2cm
    },
}

% === VAE ç‰¹æ®Šæ ·å¼ ===
\tikzset{
    % å‡å€¼å‘é‡
    mu block/.style={
        rectangle,
        draw=nn@mu!80!black,
        fill=nn@mu!40,
        rounded corners=3pt,
        minimum width=1cm,
        minimum height=1.5cm,
        thick
    },
    % æ–¹å·®å‘é‡
    sigma block/.style={
        rectangle,
        draw=nn@sigma!80!black,
        fill=nn@sigma!30,
        rounded corners=3pt,
        minimum width=1cm,
        minimum height=1.5cm,
        thick
    },
    % é‡‡æ ·å—
    sample block/.style={
        rectangle,
        draw=nn@sample!80!black,
        fill=nn@sample!30,
        rounded corners=3pt,
        minimum width=1cm,
        minimum height=1.5cm,
        thick
    },
    % æ½œåœ¨ç©ºé—´
    latent space/.style={
        ellipse,
        draw=nn@mu!60!nn@sigma,
        fill=nn@mu!10!nn@sigma!10,
        minimum width=2cm,
        minimum height=1.5cm,
        thick
    },
}

% === ç‰¹æ®Šç½‘ç»œç»„ä»¶ ===
\tikzset{
    % æ³¨æ„åŠ›æœºåˆ¶
    attention/.style={
        rectangle,
        draw=orange!80!black,
        fill=orange!20,
        rounded corners=3pt,
        minimum width=1.5cm,
        minimum height=0.8cm,
        font=\small
    },
    % BatchNorm
    batchnorm/.style={
        rectangle,
        draw=green!60!black,
        fill=green!15,
        minimum width=0.3cm,
        minimum height=1.5cm
    },
    % ç‰¹å¾å›¾
    feature map/.style={
        rectangle,
        draw=nn@conv!60,
        fill=nn@conv!15,
        minimum width=#1,
        minimum height=#1
    },
    feature map/.default=1cm,
    % Mask (MADE)
    mask matrix/.style={
        draw=black,
        thick
    },
    mask cell/.style={
        fill=black,
        draw=none
    },
}

% === æ ‡ç­¾æ ·å¼ ===
\tikzset{
    % å±‚æ ‡ç­¾
    layer label/.style={
        font=\small\bfseries,
        text=black!70
    },
    % ç½‘ç»œæ ‡é¢˜
    nn title/.style={
        font=\large\bfseries
    },
    % ç»´åº¦æ ‡ç­¾
    dim label/.style={
        font=\scriptsize,
        text=gray!70
    },
}

% === å¿«æ·å‘½ä»¤ ===

% ç»˜åˆ¶å…¨è¿æ¥å±‚çš„ç¥ç»å…ƒ
% ç”¨æ³•: \drawlayer{å‘½åç©ºé—´}{å±‚å·}{ç¥ç»å…ƒæ•°}{xä½ç½®}{èµ·å§‹y}{é—´è·}
\newcommand{\drawlayer}[6]{%
    \foreach \i in {1,...,#3} {
        \pgfmathsetmacro{\ypos}{#5 - (\i-1)*#6}
        \node[hidden neuron] (#1-#2-\i) at (#4, \ypos) {};
    }
}

% å…¨è¿æ¥ä¸¤å±‚
% ç”¨æ³•: \connectlayers{å‘½åç©ºé—´}{æºå±‚å·}{æºæ•°é‡}{ç›®æ ‡å±‚å·}{ç›®æ ‡æ•°é‡}
\newcommand{\connectlayers}[5]{%
    \foreach \i in {1,...,#3} {
        \foreach \j in {1,...,#5} {
            \draw[nn edge] (#1-#2-\i) -- (#1-#4-\j);
        }
    }
}

% ç¥ç»ç½‘ç»œç¯å¢ƒ
\newenvironment{neuralnet}[1][1.5cm]{%
    \begin{center}
    \begin{tikzpicture}[node distance=#1, >=Stealth, shorten >=1pt, shorten <=1pt]
}{%
    \end{tikzpicture}
    \end{center}
}

% è‡ªç¼–ç å™¨ç¯å¢ƒ
\newenvironment{autoencoder}[1][2cm]{%
    \begin{center}
    \begin{tikzpicture}[node distance=#1, >=Stealth]
}{%
    \end{tikzpicture}
    \end{center}
}

% CNN ç¯å¢ƒ
\newenvironment{convnet}[1][0.8cm]{%
    \begin{center}
    \begin{tikzpicture}[node distance=#1, >=Stealth]
}{%
    \end{tikzpicture}
    \end{center}
}

% ---------------------------------------------------------
% [21.23] æ¦‚ç‡æ ‘ä¸å†³ç­–æ ‘æ ·å¼ (Probability & Decision Trees)
% ---------------------------------------------------------
% ğŸ’¡ æ¦‚ç‡æ ‘/å†³ç­–æ ‘/è´å¶æ–¯ç½‘ç»œ/æ¦‚ç‡è¡¨

% === æ¦‚ç‡æ ‘é…è‰² ===
\definecolor{prob@highlight}{RGB}{70,130,220}
\definecolor{prob@event}{RGB}{100,180,100}
\definecolor{prob@outcome}{RGB}{220,150,100}

% === æ¦‚ç‡æ ‘èŠ‚ç‚¹æ ·å¼ ===
\tikzset{
    % æ¦‚ç‡æ ‘æ ¹èŠ‚ç‚¹
    prob root/.style={
        circle,
        draw=black!70,
        fill=white,
        minimum size=3pt,
        inner sep=0pt
    },
    % äº‹ä»¶èŠ‚ç‚¹
    prob event/.style={
        circle,
        draw=black!70,
        thick,
        minimum size=2em,
        font=\small
    },
    % é«˜äº®äº‹ä»¶èŠ‚ç‚¹
    prob event highlight/.style={
        prob event,
        draw=prob@highlight,
        thick
    },
    % ç»“æœèŠ‚ç‚¹
    prob outcome/.style={
        rectangle,
        draw=black!50,
        rounded corners=2pt,
        minimum height=1.5em,
        font=\small
    },
    % å†³ç­–èŠ‚ç‚¹ (æ–¹å½¢)
    decision node/.style={
        rectangle,
        draw=black!70,
        thick,
        minimum size=2em,
        font=\small
    },
    % æœºä¼šèŠ‚ç‚¹ (åœ†å½¢)
    chance node/.style={
        circle,
        draw=black!70,
        thick,
        minimum size=2em,
        font=\small
    },
}

% === æ¦‚ç‡æ ‘è¾¹æ ·å¼ ===
\tikzset{
    % æ¦‚ç‡è¾¹
    prob edge/.style={
        ->,
        >=Stealth,
        thick,
        draw=black!60
    },
    % é«˜äº®æ¦‚ç‡è¾¹
    prob edge highlight/.style={
        prob edge,
        draw=prob@highlight,
        very thick
    },
    % æ¦‚ç‡æ ‡ç­¾
    prob label/.style={
        font=\footnotesize,
        inner sep=1pt,
        outer sep=2pt,
        circle
    },
    % é«˜äº®æ¦‚ç‡æ ‡ç­¾
    prob label highlight/.style={
        prob label,
        draw=prob@highlight,
        text=prob@highlight
    },
}

% === æ¦‚ç‡è¡¨æ ¼æ ·å¼ ===
\tikzset{
    % æ¦‚ç‡è¡¨æ ¼çŸ©é˜µ
    prob table/.style={
        matrix of math nodes,
        nodes in empty cells,
        row sep=-\pgflinewidth,
        column sep=5mm,
        nodes={
            minimum height=2em,
            anchor=center
        }
    },
    % è¡¨æ ¼é«˜äº®å•å…ƒæ ¼
    prob cell highlight/.style={
        draw=prob@highlight,
        fill=prob@highlight!10
    },
    % è¡¨æ ¼æ ‡é¢˜è¡Œ
    prob header/.style={
        font=\bfseries,
        fill=gray!10
    },
}

% ---------------------------------------------------------
% [21.24] å·ç§¯è¿ç®—å¯è§†åŒ–æ ·å¼ (Convolution Operation)
% ---------------------------------------------------------
% ğŸ’¡ CNNå·ç§¯/æ ¸/ç‰¹å¾å›¾/2DçŸ©é˜µ

% === å·ç§¯é…è‰² ===
\definecolor{conv@input}{RGB}{255,180,100}
\definecolor{conv@kernel}{RGB}{100,180,180}
\definecolor{conv@output}{RGB}{100,130,220}

% === 2Dæ•°ç»„çŸ©é˜µæ ·å¼ ===
\tikzset{
    % 2Dæ•°ç»„åŸºç¡€æ ·å¼
    2d array/.style={
        matrix of nodes,
        row sep=-\pgflinewidth,
        column sep=-\pgflinewidth,
        nodes={
            draw,
            minimum size=2em,
            anchor=center,
            font=\small
        }
    },
    % è¾“å…¥çŸ©é˜µ
    input matrix/.style={
        2d array,
        nodes={draw=black!50}
    },
    % å·ç§¯æ ¸çŸ©é˜µ
    kernel matrix/.style={
        2d array,
        nodes={draw=conv@kernel!80!black, fill=conv@kernel!30}
    },
    % è¾“å‡ºçŸ©é˜µ
    output matrix/.style={
        2d array,
        nodes={draw=black!50}
    },
    % é«˜äº®è¾“å…¥åŒºåŸŸ
    conv input highlight/.style={
        fill=conv@input!30
    },
    % é«˜äº®è¾“å‡ºå•å…ƒ
    conv output highlight/.style={
        fill=conv@output!30
    },
    % å·ç§¯æ ¸å•å…ƒ
    kernel cell/.style={
        fill=conv@kernel!30
    },
}

% === å·ç§¯è¿æ¥æ ·å¼ ===
\tikzset{
    % å·ç§¯æ˜ å°„çº¿
    conv map/.style={
        dashed,
        draw=conv@kernel!80!black
    },
    % è¾“å‡ºæ˜ å°„çº¿
    output map/.style={
        dashed,
        draw=conv@output!80!black
    },
    % å·ç§¯è¿ç®—ç¬¦
    conv operator/.style={
        font=\Large
    },
    % ä¹˜æ³•æ ‡æ³¨
    multiply label/.style={
        font=\tiny,
        scale=0.6,
        shift={(-1.2ex,-2ex)}
    },
}

% === å¿«æ·å‘½ä»¤ ===

% ç»˜åˆ¶æ¦‚ç‡æ ‡ç­¾
% ç”¨æ³•: \problabel{æ¦‚ç‡å€¼}
\newcommand{\problabel}[1]{edge node[prob label]{#1}}

% ç»˜åˆ¶é«˜äº®æ¦‚ç‡æ ‡ç­¾
% ç”¨æ³•: \problabelhigh{æ¦‚ç‡å€¼}
\newcommand{\problabelhigh}[1]{edge node[prob label highlight]{#1}}

% æ¦‚ç‡æ ‘ç¯å¢ƒ
\newenvironment{probtree}[1][1.5cm]{%
    \begin{center}
    \begin{tikzpicture}[
        grow=right,
        level distance=#1,
        sibling distance=8mm,
        edge from parent/.style={prob edge},
        >=Stealth
    ]
}{%
    \end{tikzpicture}
    \end{center}
}

% å†³ç­–æ ‘ç¯å¢ƒ
\newenvironment{decisiontree}[1][2cm]{%
    \begin{center}
    \begin{tikzpicture}[
        grow=right,
        level distance=#1,
        sibling distance=10mm,
        >=Stealth
    ]
}{%
    \end{tikzpicture}
    \end{center}
}

% å·ç§¯è¿ç®—ç¯å¢ƒ
\newenvironment{convolution}[1][1cm]{%
    \begin{center}
    \begin{tikzpicture}[node distance=#1]
}{%
    \end{tikzpicture}
    \end{center}
}

% ---------------------------------------------------------
% [21.26] TQFT åè¾¹å›¾æ ·å¼ (Topological Quantum Field Theory)
% ---------------------------------------------------------
% ğŸ’¡ æ‹“æ‰‘é‡å­åœºè®º/åè¾¹/pants/cup/cap

% === TQFT åŸºç¡€æ ·å¼ ===
\tikzset{
    % TQFT é€šç”¨æ ·å¼
    tqft style/.style={
        every tqft/.append style={
            transform shape,
            rotate=90,
            tqft/circle x radius=7pt,
            tqft/boundary separation=1cm,
            tqft/view from=incoming
        }
    },
    % åè¾¹è¾¹ç•Œ
    cobordism boundary/.style={
        draw
    },
    % åè¾¹è¾¹
    cobordism edge/.style={
        draw
    },
    % åè¾¹å¡«å……
    cobordism fill/.style={
        fill=blue!10
    },
}

% === TQFT æ³¨é‡Šæ ·å¼ ===
\tikzset{
    % æ—¶é—´å‚æ•°æ ‡æ³¨
    time param/.style={
        dashed,
        draw=black!70
    },
    % ç©ºé—´å‚æ•°æ ‡æ³¨
    space param/.style={
        ->,
        >=Stealth,
        draw=black!70
    },
    % å‚æ•°æ ‡ç­¾
    tqft label/.style={
        font=\small
    },
}

% === æ‹“æ‰‘å¯¹è±¡æ ·å¼ ===
\tikzset{
    % ç¯é¢åˆ‡ç‰‡
    torus slice/.style={
        draw,
        thick
    },
    % çƒé¢
    sphere boundary/.style={
        draw,
        shape=circle,
        minimum width=1.5cm
    },
    % äºæ ¼æ ‡è®°
    genus mark/.style={
        dashed
    },
}

% === å¿«æ· TQFT è®¾ç½® ===

% TQFT åè¾¹ç¯å¢ƒ
\newenvironment{cobordism}[1][1]{%
    \begin{center}
    \begin{tikzpicture}[
        scale=#1,
        every tqft/.append style={
            transform shape,
            rotate=90,
            tqft/circle x radius=7pt,
            tqft/boundary separation=1cm,
            tqft/view from=incoming
        }
    ]
}{%
    \end{tikzpicture}
    \end{center}
}

% TQFT å›¾ç¯å¢ƒ (æ°´å¹³æ–¹å‘)
\newenvironment{tqftdiagram}[1][1]{%
    \begin{center}
    \begin{tikzpicture}[
        scale=#1,
        every tqft/.append style={
            transform shape,
            tqft/circle x radius=7pt,
            tqft/boundary separation=1cm
        }
    ]
}{%
    \end{tikzpicture}
    \end{center}
}

% ---------------------------------------------------------
% [21.28] æ™¶æ ¼ä¸æ‹“æ‰‘ç­‰ä»·æ ·å¼ (Lattice & Topological Identification)
% ---------------------------------------------------------
% ğŸ’¡ æ™¶æ ¼/åŸºæœ¬åŸŸ/ç­‰ä»·ç²˜åˆ/ç¯é¢æ„é€ 

% === æ™¶æ ¼é…è‰² ===
\definecolor{lattice@primary}{RGB}{70,130,180}
\definecolor{lattice@domain}{RGB}{255,200,100}
\definecolor{lattice@arrow}{RGB}{180,80,80}

% === æ™¶æ ¼æ ·å¼ ===
\tikzset{
    % æ™¶æ ¼ç½‘æ ¼
    lattice grid/.style={
        draw=gray!50,
        thin
    },
    % åæ ‡è½´
    lattice axis/.style={
        ->,
        >=Stealth,
        ultra thick,
        draw=black
    },
    % åŸºæœ¬åŸŸ
    fundamental domain/.style={
        draw=lattice@primary,
        ultra thick,
        rectangle,
        minimum width=1cm,
        minimum height=1cm
    },
    % å‘¨æœŸæ€§æ ‡æ³¨
    period label/.style={
        font=\small
    },
}

% === æ‹“æ‰‘ç­‰ä»·æ ·å¼ ===
\tikzset{
    % ç­‰ä»·ç®­å¤´ (ç”¨äºç²˜åˆè¾¹)
    identification arrow/.style={
        postaction={decorate},
        decoration={
            markings,
            mark=at position 0.5 with {\arrow{latex}}
        }
    },
    % åå‘ç­‰ä»·ç®­å¤´
    identification arrow reversed/.style={
        postaction={decorate},
        decoration={
            markings,
            mark=at position 0.5 with {\arrowreversed{latex}}
        }
    },
    % åŒå‘ç®­å¤´æ ‡è®°
    identification double/.style={
        postaction={decorate},
        decoration={
            markings,
            mark=at position 0.25 with {\arrow{latex}},
            mark=at position 0.75 with {\arrow{latex}}
        }
    },
}

% === æ›²é¢æ„é€ æ ·å¼ ===
\tikzset{
    % åœ†æŸ±é¢è¾¹
    cylinder side/.style={
        draw=black,
        thick
    },
    % åœ†æŸ±é¢ç«¯
    cylinder end/.style={
        draw=black,
        thick,
        ellipse
    },
    % ç¯é¢å¤–ç¯
    torus outer/.style={
        draw=black,
        thick
    },
    % ç¯é¢å†…ç¯ (è™šçº¿)
    torus inner/.style={
        draw=black,
        thick,
        dashed
    },
    % MÃ¶bius å¸¦è¾¹
    mobius edge/.style={
        draw=black,
        thick
    },
}

% === æ‰‹æœ¯/ç²˜åˆæ ‡è®° ===
\tikzset{
    % åˆ‡å‰²çº¿
    cut line/.style={
        draw=lattice@arrow,
        thick,
        dashed
    },
    % ç²˜åˆç‚¹
    glue point/.style={
        circle,
        fill=lattice@arrow,
        inner sep=2pt
    },
    % ç­‰ä»·æ ‡è®°
    equiv mark/.style={
        font=\small,
        text=lattice@primary
    },
}

% === æ™¶æ ¼ç¯å¢ƒ ===
\newenvironment{latticediag}[1][1]{%
    \begin{center}
    \begin{tikzpicture}[scale=#1]
}{%
    \end{tikzpicture}
    \end{center}
}

% === æ›²é¢æ„é€ ç¯å¢ƒ ===
\newenvironment{surfaceconstruct}[1][1]{%
    \begin{center}
    \begin{tikzpicture}[scale=#1]
}{%
    \end{tikzpicture}
    \end{center}
}

% ---------------------------------------------------------
% [21.30] ç”µç£æ³¢ä¸å…‰å­¦æ ·å¼ (Electromagnetic Waves & Optics)
% ---------------------------------------------------------
% ğŸ’¡ åæŒ¯å…‰/ç”µç£æ³¢/å…‰å­¦å…ƒä»¶

% === ç”µç£æ³¢é…è‰² ===
\definecolor{em@efield}{RGB}{220,50,50}
\definecolor{em@bfield}{RGB}{50,50,220}
\definecolor{em@propagation}{RGB}{50,150,50}
\definecolor{em@polarizer}{RGB}{100,100,100}

% === æ³¢åŠ¨æ ·å¼ ===
\tikzset{
    % ä¼ æ’­æ–¹å‘
    propagation arrow/.style={
        very thick,
        ->,
        >=Stealth,
        draw=em@propagation
    },
    % ç”µåœºå‘é‡
    E field/.style={
        ->,
        >=Latex,
        thick,
        draw=em@efield
    },
    % ç£åœºå‘é‡
    B field/.style={
        ->,
        >=Latex,
        thick,
        draw=em@bfield
    },
    % æ³¢å½¢æ›²çº¿
    wave curve/.style={
        very thick,
        draw=em@efield,
        samples=300
    },
    % æ³¢å½¢æ›²çº¿ (ç£åœº)
    wave curve B/.style={
        very thick,
        draw=em@bfield,
        samples=300
    },
}

% === åæŒ¯å…ƒä»¶æ ·å¼ ===
\tikzset{
    % åæŒ¯ç‰‡
    polarizer/.style={
        thick,
        fill=em@polarizer!40,
        draw=em@polarizer
    },
    % åæŒ¯æ–¹å‘
    polarization axis/.style={
        thick,
        dashed,
        draw=em@polarizer
    },
    % æ³¢ç‰‡
    wave plate/.style={
        thick,
        fill=blue!20,
        draw=blue!60
    },
}

% === 3D å…‰å­¦æ ·å¼ ===
\tikzset{
    % å…‰æŸæˆªé¢
    beam cross section/.style={
        thick,
        fill=black!10,
        draw=black!50
    },
    % èºæ—‹çº¿ (åœ†åæŒ¯)
    helix path/.style={
        very thick,
        draw=em@efield
    },
    % åœºå‘é‡å°ç®­å¤´
    field vector/.style={
        -{Latex[length=0.8mm]},
        draw=em@efield
    },
}

% === å…‰å­¦æ³¨é‡Š ===
\tikzset{
    % ä¼ æ’­æ ‡ç­¾
    propagation label/.style={
        font=\small,
        align=center
    },
    % åæŒ¯ç±»å‹æ ‡ç­¾
    polarization label/.style={
        font=\small,
        align=center
    },
}

% === å¿«æ·å‘½ä»¤ ===

% ç»˜åˆ¶3DçŸ©å½¢æˆªé¢
% ç”¨æ³•: \drawbeamrect{xä½ç½®}{yåŠå®½}{zåŠå®½}
\newcommand{\drawbeamrect}[3]{%
    \begin{scope}[canvas is xz plane at y=#2]
        \draw[beam cross section] (#1,-#3) rectangle (#1+0.2,#3);
    \end{scope}
    \begin{scope}[canvas is xy plane at z=#3]
        \draw[beam cross section] (#1,-#2) rectangle (#1+0.2,#2);
    \end{scope}
    \begin{scope}[canvas is yz plane at x=#1]
        \draw[beam cross section] (-#2,-#3) rectangle (#2,#3);
        \draw[thick, dashed] (0,0) ellipse (0.7*#2 and 0.7*#3);
    \end{scope}
}

% ç”µç£æ³¢ç¯å¢ƒ
\newenvironment{emwave}[1][1]{%
    \begin{center}
    \begin{tikzpicture}[
        scale=#1,
        x={(0.8cm, 0.4cm)},
        y={(0.9cm, -0.3cm)},
        z={(0cm,1cm)},
        line cap=round,
        line join=round,
        >=Stealth
    ]
}{%
    \end{tikzpicture}
    \end{center}
}

% å…‰å­¦ç³»ç»Ÿç¯å¢ƒ
\newenvironment{optics}[1][1]{%
    \begin{center}
    \begin{tikzpicture}[scale=#1, >=Stealth]
}{%
    \end{tikzpicture}
    \end{center}
}

% [21.31] æœ¯è¯­è¡¨ (Nomenclature) Stub
% é¢„ç•™æ¥å£ï¼Œç”¨æˆ·éœ€è‡ªè¡Œå¼•å…¥ nomencl åŒ…
\newcommand{\makenom}{\typeout{>> [MindFlow] Nomenclature support enabled.}}

\floatname{algorithm}{ç®—æ³•}
\renewcommand{\algorithmicrequire}{\textbf{è¾“å…¥:}}
\renewcommand{\algorithmicensure}{\textbf{è¾“å‡º:}}


% ---------------------------------------------------------
% 4. å­—ä½“é…ç½® (æ™ºèƒ½æ£€æµ‹ + å¤šå¹³å°é€‚é…)
% ---------------------------------------------------------
\makeatletter

% æ¸…é™¤æ—§å®šä¹‰
\let\songti\relax
\let\heiti\relax
\let\kaiti\relax

% --- 4.1 è‹±æ–‡å­—ä½“é…ç½® ---
\IfFileExists{fonts/times.ttf}{
    \typeout{>> [MindFlow] Local English fonts found (fonts/times.ttf).}
    \setmainfont{times.ttf}[
        Path = fonts/,
        BoldFont = timesbd.ttf,
        ItalicFont = timesi.ttf,
        BoldItalicFont = timesbi.ttf
    ]
}{
    \ifmf@oswin
        \setmainfont{Times New Roman}
    \else
        \ifmf@osmac
            \setmainfont{Times New Roman}
        \else
            \setmainfont{TeX Gyre Termes}
        \fi
    \fi
}

% --- 4.2 ä¸­æ–‡å­—ä½“é…ç½® ---
\IfFileExists{fonts/SimSun.ttf}{
    \typeout{>> [MindFlow] Local Chinese fonts found (fonts/SimSun.ttf).}
    \defaultfontfeatures{Ligatures=TeX}
    
    % é¢„åˆ¤å­—ä½“æ–‡ä»¶
    \IfFileExists{fonts/SimHei.ttf}{%
        \def\mf@cjk@bold{SimHei.ttf}%
        \def\mf@cjk@fakebold{false}%
    }{%
        \def\mf@cjk@bold{SimSun.ttf}%
        \def\mf@cjk@fakebold{2.5}%
    }%
    
    \IfFileExists{fonts/KaiTi.ttf}{%
        \def\mf@cjk@italic{KaiTi.ttf}%
    }{%
        \def\mf@cjk@italic{SimSun.ttf}%
    }%
    
    % ä¸»å­—ä½“è®¾ç½®
    \setCJKmainfont{SimSun.ttf}[
        Path = fonts/,
        BoldFont = \mf@cjk@bold,
        ItalicFont = \mf@cjk@italic,
        AutoFakeBold = \mf@cjk@fakebold
    ]
    
    % é…å¥—å­—ä½“è®¾ç½®
    \IfFileExists{fonts/SimHei.ttf}{
        \setCJKsansfont{SimHei.ttf}[Path = fonts/]
        \newCJKfontfamily\heiti{SimHei.ttf}[Path=fonts/]
    }{
        \setCJKsansfont{SimSun.ttf}[Path = fonts/, AutoFakeBold=2.5]
        \newCJKfontfamily\heiti{SimSun.ttf}[Path=fonts/, AutoFakeBold=2.5]
    }
    
    \IfFileExists{fonts/KaiTi.ttf}{
        \setCJKmonofont{KaiTi.ttf}[Path = fonts/]
        \newCJKfontfamily\kaiti{KaiTi.ttf}[Path=fonts/]
    }{
        \setCJKmonofont{SimSun.ttf}[Path = fonts/, AutoFakeBold=2.5]
        \newCJKfontfamily\kaiti{SimSun.ttf}[Path=fonts/, AutoFakeBold=2.5]
    }
    
    \newCJKfontfamily\songti{SimSun.ttf}[Path=fonts/, AutoFakeBold=2.5]

}{
    % [ç³»ç»Ÿå›é€€]
    \ifmf@oswin
        \typeout{>> [MindFlow] Using Windows system fonts.}
        \setCJKmainfont[BoldFont=SimHei,ItalicFont=KaiTi,AutoFakeBold=2.5]{SimSun}
        \setCJKsansfont[AutoFakeBold=2.5]{SimHei}
        \setCJKmonofont[AutoFakeBold=2.5]{KaiTi}
        \newCJKfontfamily\songti{SimSun}[BoldFont=SimHei,ItalicFont=KaiTi,AutoFakeBold=2.5]
        \newCJKfontfamily\heiti{SimHei}[AutoFakeBold=2.5]
        \newCJKfontfamily\kaiti{KaiTi}[AutoFakeBold=2.5]
    \else
    \ifmf@osmac
        \typeout{>> [MindFlow] Using macOS system fonts.}
        \setCJKmainfont[BoldFont=Heiti SC Medium,ItalicFont=Kaiti SC,AutoFakeBold=2.0]{Songti SC Light}
        \setCJKsansfont[AutoFakeBold=2.0]{Heiti SC Medium}
        \setCJKmonofont[AutoFakeBold=2.0]{Kaiti SC}
        \newCJKfontfamily\songti{Songti SC Light}[BoldFont=Heiti SC Medium,ItalicFont=Kaiti SC, AutoFakeBold=2.0]
        \newCJKfontfamily\heiti{Heiti SC Medium}
        \newCJKfontfamily\kaiti{Kaiti SC}
    \else
        % Linux / Default (Fandol)
        \typeout{>> [MindFlow] Using Fandol fonts (Linux/Fallback).}
        \setCJKmainfont[
            Extension=.otf,
            BoldFont=FandolHei-Regular,
            BoldFeatures={FakeBold=3},
            ItalicFont=FandolKai-Regular,
            ItalicFeatures={FakeSlant=0.2}
        ]{FandolSong-Regular}
        \setCJKsansfont[Extension=.otf, BoldFont=FandolHei-Regular, BoldFeatures={FakeBold=3}]{FandolHei-Regular}
        \setCJKmonofont[Extension=.otf, BoldFont=FandolKai-Regular, BoldFeatures={FakeBold=3}]{FandolKai-Regular}
        \newCJKfontfamily\songti[Extension=.otf]{FandolSong-Regular}
        \newCJKfontfamily\heiti[Extension=.otf]{FandolHei-Regular}
        \newCJKfontfamily\kaiti[Extension=.otf]{FandolKai-Regular}
    \fi
    \fi
}


% ---------------------------------------------------------
% 5. é¡µé¢å¸ƒå±€
% ---------------------------------------------------------
\geometry{
    a4paper,
    left=2.5cm,
    right=2.5cm,
    top=2.5cm,
    bottom=2.5cm,
    headheight=15pt
}
\pagestyle{plain}

% [5.1] è‡ªå®šä¹‰ç›®å½•å‘½ä»¤ï¼šç›®å½•ä½¿ç”¨ç½—é©¬æ•°å­—é¡µç ï¼Œæ­£æ–‡ä»1å¼€å§‹
% ğŸ’¡ book æ¨¡å¼ä½¿ç”¨ \frontmatter/\mainmatterï¼Œå…¶ä»–æ¨¡å¼ä½¿ç”¨ \pagenumbering
% ğŸ’¡ åŒæ—¶é‡ç½® section/chapter è®¡æ•°å™¨ï¼Œç¡®ä¿æ­£æ–‡ç¼–å·ä»1å¼€å§‹
\newcommand{\mftableofcontents}{%
    \ifmf@book
        \frontmatter  % book æ¨¡å¼ï¼šç½—é©¬æ•°å­—é¡µç 
        \tableofcontents
        \mainmatter   % åˆ‡æ¢åˆ°é˜¿æ‹‰ä¼¯æ•°å­—ï¼Œé¡µç ä»1å¼€å§‹
        \setcounter{chapter}{0}%  é‡ç½®ç« è®¡æ•°å™¨
    \else
        \pagenumbering{roman}%
        \tableofcontents%
        \clearpage
        \pagenumbering{arabic}%
        \setcounter{section}{0}%  é‡ç½®èŠ‚è®¡æ•°å™¨
    \fi
}


% ---------------------------------------------------------
% 6. ç« èŠ‚æ ‡é¢˜æ ·å¼ (ç»å…¸ä¸­æ–‡ä¹¦ç±é£æ ¼)
% ---------------------------------------------------------
% ğŸ’¡ æ ·å¼è¯´æ˜ï¼šé¡¶éƒ¨æ¨ªçº¿ + å³ä¾§ç«–æ’"ç¬¬Xç« " + å·¦ä¸‹æ–¹ç« èŠ‚æ ‡é¢˜

% å®šä¹‰ç« èŠ‚æ ‡é¢˜ç»˜åˆ¶å‘½ä»¤
\newcommand{\mf@chaptertitle}[2]{%
    % #1 = ç« èŠ‚ç¼–å· (å¦‚ 1, 2, 3...)
    % #2 = ç« èŠ‚æ ‡é¢˜
    \begin{tikzpicture}[remember picture, overlay]
        % é¡¶éƒ¨æ¨ªçº¿ (ä»å·¦è¾¹è·åˆ°å³è¾¹è·)
        \draw[line width=1.2pt, black] 
            ([yshift=-0.5cm]current page.north west |- 0,0) ++(\dimexpr\oddsidemargin+1in,0)
            -- ++(\textwidth,0);
    \end{tikzpicture}%
    \noindent
    \begin{minipage}[t]{\textwidth}
        \vspace{0.8cm}
        \begin{flushright}
            % å³ä¾§ç«–æ’"ç¬¬Xç« "
            \begin{minipage}[t]{1.5cm}
                \centering
                \fontsize{18pt}{22pt}\selectfont\heiti
                ç¬¬\\[0.3em]
                {\fontsize{36pt}{40pt}\selectfont #1}\\[0.3em]
                ç« 
            \end{minipage}
        \end{flushright}
        \vspace{-1.5cm}
        % å·¦ä¾§ç« èŠ‚æ ‡é¢˜
        \noindent
        {\fontsize{22pt}{28pt}\selectfont\heiti\bfseries #2}
        \par\vspace{1.5cm}
    \end{minipage}
}

% å®šä¹‰ç®€æ´ç« èŠ‚æ ‡é¢˜ - Classic æ ·å¼ (é»˜è®¤)
% ğŸ’¡ è“è‰²ç¼–å·å— + æµ…è“èƒŒæ™¯æ ‡é¢˜
\newcommand{\mf@sectitle@classic}[2]{%
    \definecolor{mf@sec@blue}{RGB}{30,90,150}
    \begin{tcolorbox}[
        enhanced,
        colback=white,
        colframe=white,
        boxrule=0pt,
        arc=0pt,
        left=0pt, right=0pt, top=0pt, bottom=0pt,
        before skip=15pt,
        after skip=15pt
    ]
        % ç¼–å·å—
        \begin{tcolorbox}[
            enhanced,
            width=1.5cm,
            nobeforeafter,
            colback=mf@sec@blue,
            colframe=mf@sec@blue,
            halign=center,
            valign=center,
            arc=4pt,
            boxrule=0pt,
            top=6pt, bottom=6pt
        ]
            \color{white}\bfseries\zihao{3} #1
        \end{tcolorbox}%
        \hspace{0.5em}%
        % æ ‡é¢˜å—
        \begin{tcolorbox}[
            enhanced,
            width=\dimexpr\textwidth-1.5cm-0.8em\relax,
            nobeforeafter,
            colback=mf@sec@blue!8!white,
            colframe=mf@sec@blue!8!white,
            valign=center,
            arc=4pt,
            boxrule=0pt,
            left=10pt,
            top=6pt,
            bottom=6pt
        ]
            \color{mf@sec@blue}\bfseries\zihao{-3}\heiti #2
        \end{tcolorbox}
    \end{tcolorbox}%
}

% Modern æ ·å¼: æ¸å˜åº•è¾¹çº¿ + å¤§å·ç¼–å·
\newcommand{\mf@sectitle@modern}[2]{%
    \definecolor{mf@mod@start}{RGB}{70,130,180}
    \definecolor{mf@mod@end}{RGB}{135,206,250}
    \par\vspace{20pt}
    \noindent
    \begin{minipage}{\textwidth}
        % å¤§å·ç¼–å·
        {\fontsize{32pt}{36pt}\selectfont\bfseries\color{mf@mod@start}#1}%
        \hspace{0.5em}%
        % æ ‡é¢˜
        {\fontsize{16pt}{20pt}\selectfont\heiti\bfseries #2}
        \par\vspace{6pt}
        % æ¸å˜åº•çº¿
        \begin{tikzpicture}
            \shade[left color=mf@mod@start, right color=mf@mod@end, opacity=0.8]
                (0,0) rectangle (\textwidth, 2pt);
        \end{tikzpicture}
    \end{minipage}
    \par\vspace{15pt}
}

% Minimal æ ·å¼: çº¯æ–‡æœ¬ + å·¦ä¾§ç«–çº¿
\newcommand{\mf@sectitle@minimal}[2]{%
    \definecolor{mf@min@gray}{RGB}{100,100,100}
    \par\vspace{18pt}
    \noindent
    \begin{tikzpicture}[baseline=(text.base)]
        % å·¦ä¾§ç«–çº¿
        \fill[mf@min@gray] (0, -0.3em) rectangle (3pt, 1.2em);
        % ç¼–å·å’Œæ ‡é¢˜
        \node[anchor=west, inner sep=0] (text) at (10pt, 0.4em) {%
            {\zihao{3}\bfseries\color{mf@min@gray}#1}\hspace{0.8em}%
            {\zihao{-3}\heiti\bfseries #2}%
        };
    \end{tikzpicture}
    \par\vspace{12pt}
}

% Boxed æ ·å¼: å®Œæ•´è¾¹æ¡†å¡ç‰‡
\newcommand{\mf@sectitle@boxed}[2]{%
    \definecolor{mf@box@border}{RGB}{60,60,60}
    \definecolor{mf@box@bg}{RGB}{250,250,250}
    \begin{tcolorbox}[
        enhanced,
        colback=mf@box@bg,
        colframe=mf@box@border,
        boxrule=1.5pt,
        arc=6pt,
        left=12pt, right=12pt, top=10pt, bottom=10pt,
        before skip=18pt,
        after skip=15pt,
        shadow={2pt}{-2pt}{0pt}{black!20}
    ]
        {\zihao{3}\bfseries\color{mf@box@border}#1}\hspace{1em}%
        {\zihao{-3}\heiti\bfseries #2}
    \end{tcolorbox}
}

% =========================================================
% æè‡´ç¾åŒ–æ ·å¼ (v1.1)
% =========================================================

% Neon æ ·å¼: éœ“è™¹å‘å…‰è¾¹æ¡† (èµ›åšæœ‹å…‹é£)
% ğŸ’¡ æ·±è‰²èƒŒæ™¯ + å¤šå±‚å‘å…‰è¾¹æ¡† + éœ“è™¹è‰²æ–‡å­—
\newcommand{\mf@sectitle@neon}[2]{%
    \definecolor{mf@neon@bg}{RGB}{15,15,25}
    \definecolor{mf@neon@glow}{RGB}{0,255,200}
    \definecolor{mf@neon@pink}{RGB}{255,0,128}
    \begin{tcolorbox}[
        enhanced,
        colback=mf@neon@bg,
        colframe=mf@neon@glow,
        boxrule=2pt,
        arc=3pt,
        left=15pt, right=15pt, top=12pt, bottom=12pt,
        before skip=18pt,
        after skip=15pt,
        shadow={0pt}{0pt}{8pt}{mf@neon@glow!60},
        borderline={1pt}{1pt}{mf@neon@pink!70}
    ]
        {\fontsize{28pt}{32pt}\selectfont\bfseries\color{mf@neon@glow}#1}%
        \hspace{0.8em}%
        {\zihao{-3}\bfseries\color{white}#2}
    \end{tcolorbox}
}

% Terminal æ ·å¼: ç»ˆç«¯/Hacker é£æ ¼
% ğŸ’¡ æ¨¡æ‹Ÿå‘½ä»¤è¡Œç•Œé¢ï¼šé»‘åº•ç»¿å­— + å‘½ä»¤æç¤ºç¬¦
\newcommand{\mf@sectitle@terminal}[2]{%
    \definecolor{mf@term@bg}{RGB}{30,30,30}
    \definecolor{mf@term@green}{RGB}{0,255,0}
    \definecolor{mf@term@gray}{RGB}{100,100,100}
    \begin{tcolorbox}[
        enhanced,
        colback=mf@term@bg,
        colframe=mf@term@gray,
        boxrule=1pt,
        arc=0pt,
        left=10pt, right=10pt, top=8pt, bottom=8pt,
        before skip=18pt,
        after skip=15pt,
        fontupper=\ttfamily
    ]
        \textcolor{mf@term@gray}{user@mindflow:}\textcolor{mf@term@green}{\textasciitilde}\textcolor{white}{\$}~%
        \textcolor{mf@term@green}{\bfseries section}~%
        \textcolor{white}{--id=}\textcolor{yellow}{#1}~%
        \textcolor{white}{--title="}{\color{mf@term@green}\bfseries #2}\textcolor{white}{"}
    \end{tcolorbox}
}

% Gradient æ ·å¼: å¤šè‰²æ¸å˜èƒŒæ™¯ (ç§‘æŠ€æ„Ÿ)
% ğŸ’¡ ä»å·¦åˆ°å³çš„å½©è™¹æ¸å˜ + ç™½è‰²æ ‡é¢˜æ–‡å­—
\newcommand{\mf@sectitle@gradient}[2]{%
    \par\vspace{18pt}
    \noindent
    \begin{tikzpicture}
        % æ¸å˜èƒŒæ™¯çŸ©å½¢
        \shade[left color=blue!70!cyan, right color=purple!70!magenta, rounded corners=6pt]
            (0,0) rectangle (\textwidth, 1.6cm);
        % ç¼–å·åœ†å½¢
        \fill[white, opacity=0.25] (0.8cm, 0.8cm) circle (0.55cm);
        \node at (0.8cm, 0.8cm) {\fontsize{24pt}{28pt}\selectfont\bfseries\color{white}#1};
        % æ ‡é¢˜æ–‡å­—
        \node[anchor=west] at (1.8cm, 0.8cm) {\zihao{-3}\bfseries\color{white}#2};
    \end{tikzpicture}
    \par\vspace{15pt}
}

% Elegant æ ·å¼: é‡‘è‰²è£…é¥°çº¿ (å­¦æœ¯å…¸é›…é£)
% ğŸ’¡ ä¸Šä¸‹é‡‘è‰²è£…é¥°çº¿ + ä¸­å¤®æ ‡é¢˜ + è¡¬çº¿å­—ä½“
\newcommand{\mf@sectitle@elegant}[2]{%
    \definecolor{mf@gold}{RGB}{180,140,60}
    \definecolor{mf@gold@light}{RGB}{240,220,180}
    \par\vspace{20pt}
    \begin{center}
        % ä¸Šè£…é¥°çº¿
        \begin{tikzpicture}
            \draw[mf@gold, line width=0.8pt] (0,0) -- (0.15\textwidth,0);
            \fill[mf@gold] (0.16\textwidth, 0) circle (2pt);
            \node[inner sep=0] at (0.5\textwidth, 0) {\color{mf@gold}\tiny$\blacklozenge$~~$\blacklozenge$~~$\blacklozenge$};
            \fill[mf@gold] (0.84\textwidth, 0) circle (2pt);
            \draw[mf@gold, line width=0.8pt] (0.85\textwidth,0) -- (\textwidth,0);
        \end{tikzpicture}
        \par\vspace{8pt}
        % æ ‡é¢˜
        {\fontsize{14pt}{18pt}\selectfont\color{mf@gold}\textsc{Section}~#1}\\[4pt]
        {\zihao{3}\bfseries\heiti #2}
        \par\vspace{8pt}
        % ä¸‹è£…é¥°çº¿  
        \begin{tikzpicture}
            \draw[mf@gold, line width=0.8pt] (0,0) -- (0.3\textwidth,0);
            \draw[mf@gold, line width=0.8pt] (0.7\textwidth,0) -- (\textwidth,0);
        \end{tikzpicture}
    \end{center}
    \par\vspace{15pt}
}

% Blueprint æ ·å¼: è“å›¾ç½‘æ ¼èƒŒæ™¯ (å·¥ç¨‹å¸ˆé£æ ¼)
% ğŸ’¡ æ·±è“ç½‘æ ¼èƒŒæ™¯ + ç™½è‰²å·¥ç¨‹å­—ä½“ + åæ ‡æ ‡è®°
\newcommand{\mf@sectitle@blueprint}[2]{%
    \definecolor{mf@bp@bg}{RGB}{0,40,80}
    \definecolor{mf@bp@grid}{RGB}{0,80,140}
    \definecolor{mf@bp@line}{RGB}{100,180,255}
    \par\vspace{18pt}
    \noindent
    \begin{tikzpicture}
        % èƒŒæ™¯
        \fill[mf@bp@bg] (0,0) rectangle (\textwidth, 1.5cm);
        % ç½‘æ ¼çº¿
        \foreach \x in {0,0.5,...,17} {
            \draw[mf@bp@grid, line width=0.3pt] (\x cm,0) -- (\x cm,1.5cm);
        }
        \foreach \y in {0,0.5,1,1.5} {
            \draw[mf@bp@grid, line width=0.3pt] (0,\y cm) -- (\textwidth,\y cm);
        }
        % åæ ‡è§’æ ‡
        \node[anchor=south west, font=\tiny\ttfamily, text=mf@bp@line] at (0.1cm, 0.1cm) {SEC-#1};
        % ç¼–å·
        \draw[mf@bp@line, line width=1.5pt] (0.8cm,0.3cm) -- (0.8cm,1.2cm) -- (1.3cm,1.2cm);
        \node[anchor=west, font=\fontsize{22pt}{26pt}\selectfont\bfseries, text=white] at (0.9cm, 0.75cm) {#1};
        % æ ‡é¢˜
        \node[anchor=west, font=\zihao{-3}\bfseries, text=white] at (2.2cm, 0.75cm) {#2};
    \end{tikzpicture}
    \par\vspace{15pt}
}

% Ribbon æ ·å¼: æŠ˜å ä¸å¸¦æ•ˆæœ (ç²¾è‡´å¡ç‰‡é£)
% ğŸ’¡ å·¦ä¾§æŠ˜å ä¸å¸¦è£…é¥° + é˜´å½±å±‚æ¬¡æ„Ÿ
\newcommand{\mf@sectitle@ribbon}[2]{%
    \definecolor{mf@rb@main}{RGB}{200,60,60}
    \definecolor{mf@rb@dark}{RGB}{140,40,40}
    \definecolor{mf@rb@bg}{RGB}{255,250,245}
    \par\vspace{18pt}
    \noindent
    \begin{tikzpicture}
        % ä¸»å¡ç‰‡ (å¸¦é˜´å½±)
        \fill[black!15, rounded corners=4pt] (0.15cm,-0.1cm) rectangle (\textwidth+0.1cm, 1.4cm);
        \fill[mf@rb@bg, rounded corners=4pt] (0,0) rectangle (\textwidth, 1.5cm);
        \draw[mf@rb@main!30, line width=0.5pt, rounded corners=4pt] (0,0) rectangle (\textwidth, 1.5cm);
        % å·¦ä¾§ä¸å¸¦ä¸»ä½“
        \fill[mf@rb@main] (-0.3cm, 0.3cm) -- (1.8cm, 0.3cm) -- (1.8cm, 1.2cm) -- (-0.3cm, 1.2cm) -- cycle;
        % ä¸å¸¦æŠ˜å éƒ¨åˆ† (æ·±è‰²ä¸‰è§’)
        \fill[mf@rb@dark] (-0.3cm, 0.3cm) -- (0, 0) -- (0, 0.3cm) -- cycle;
        % ä¸å¸¦å°¾éƒ¨ç¼ºå£
        \fill[mf@rb@bg] (1.8cm, 0.6cm) -- (1.5cm, 0.75cm) -- (1.8cm, 0.9cm) -- cycle;
        % ç¼–å· (ä¸å¸¦ä¸Š)
        \node[font=\fontsize{20pt}{24pt}\selectfont\bfseries, text=white] at (0.65cm, 0.75cm) {#1};
        % æ ‡é¢˜
        \node[anchor=west, font=\zihao{-3}\heiti\bfseries, text=mf@rb@dark] at (2.1cm, 0.75cm) {#2};
    \end{tikzpicture}
    \par\vspace{15pt}
}

% [6.1] æ ·å¼é€‰æ‹©å™¨: æ ¹æ® secstyle é€‰é¡¹è°ƒç”¨å¯¹åº”æ ·å¼
\newcommand{\mf@simpletitle}[2]{%
    \ifx\mf@secstyle\mf@style@modern
        \mf@sectitle@modern{#1}{#2}%
    \else\ifx\mf@secstyle\mf@style@minimal
        \mf@sectitle@minimal{#1}{#2}%
    \else\ifx\mf@secstyle\mf@style@boxed
        \mf@sectitle@boxed{#1}{#2}%
    \else\ifx\mf@secstyle\mf@style@neon
        \mf@sectitle@neon{#1}{#2}%
    \else\ifx\mf@secstyle\mf@style@terminal
        \mf@sectitle@terminal{#1}{#2}%
    \else\ifx\mf@secstyle\mf@style@gradient
        \mf@sectitle@gradient{#1}{#2}%
    \else\ifx\mf@secstyle\mf@style@elegant
        \mf@sectitle@elegant{#1}{#2}%
    \else\ifx\mf@secstyle\mf@style@blueprint
        \mf@sectitle@blueprint{#1}{#2}%
    \else\ifx\mf@secstyle\mf@style@ribbon
        \mf@sectitle@ribbon{#1}{#2}%
    \else
        \mf@sectitle@classic{#1}{#2}%
    \fi\fi\fi\fi\fi\fi\fi\fi\fi
}
\def\mf@style@modern{modern}
\def\mf@style@minimal{minimal}
\def\mf@style@boxed{boxed}
\def\mf@style@neon{neon}
\def\mf@style@terminal{terminal}
\def\mf@style@gradient{gradient}
\def\mf@style@elegant{elegant}
\def\mf@style@blueprint{blueprint}
\def\mf@style@ribbon{ribbon}

\ifmf@book
    % Book æ¨¡å¼ï¼šä½¿ç”¨ chapterï¼Œç»å…¸æ ·å¼
    \ctexset{
        chapter = {
            format = {},
            nameformat = {},
            titleformat = {},
            aftername = {},
            beforeskip = 0pt,
            afterskip = 0pt,
            fixskip = true
        },
        section = {
            format = \zihao{3}\heiti\bfseries,
            beforeskip = 15pt,
            afterskip = 15pt
        },
        subsection = {
            format = \zihao{4}\heiti\bfseries,
            beforeskip = 10pt,
            afterskip = 10pt
        },
        subsubsection = {
            format = \zihao{-4}\songti,
            beforeskip = 8pt,
            afterskip = 8pt
        }
    }
    % é‡å®šä¹‰ chapter æ ¼å¼
    \renewcommand{\chapter}[1]{%
        \clearpage
        \refstepcounter{chapter}%
        \addcontentsline{toc}{chapter}{\protect\numberline{\thechapter}#1}%
        \mf@chaptertitle{\thechapter}{#1}%
    }
\else\ifmf@report
    % Report æ¨¡å¼ï¼šä½¿ç”¨ section ä½œä¸ºç« ï¼Œç»å…¸æ ·å¼
    \ctexset{
        section = {
            format = {},
            nameformat = {},
            titleformat = {},
            aftername = {},
            beforeskip = 20pt,
            afterskip = 0pt,
            fixskip = true
        },
        subsection = {
            format = \zihao{4}\heiti\bfseries,
            beforeskip = 12pt,
            afterskip = 8pt,
            aftername = \hspace{1em}
        },
        subsubsection = {
            format = \zihao{-4}\songti,
            beforeskip = 8pt,
            afterskip = 6pt,
            aftername = \hspace{1em}
        }
    }
    % ä½¿ç”¨ titlesec é‡å®šä¹‰ section æ ¼å¼
    \titleformat{\section}[block]
        {}  % format
        {}  % label
        {0pt}  % sep
        {\mf@chaptertitle{\arabic{section}}}  % before-code
        []  % after-code
\else
    % Note æ¨¡å¼ (é»˜è®¤)ï¼šç®€æ´æ ·å¼ï¼Œä½¿ç”¨ç±»ä¹¦é£æ ¼çš„ section
    \ctexset{
        section = {
            format = {},
            nameformat = {},
            titleformat = {},
            aftername = {},
            beforeskip = 15pt,
            afterskip = 0pt,
            fixskip = true
        },
        subsection = {
            format = \zihao{4}\heiti\bfseries,
            beforeskip = 10pt,
            afterskip = 8pt,
            aftername = \hspace{1em}
        },
        subsubsection = {
            format = \zihao{-4}\heiti,
            beforeskip = 8pt,
            afterskip = 6pt,
            aftername = \hspace{1em}
        }
    }
    % ä½¿ç”¨ titlesec é‡å®šä¹‰ section æ ¼å¼
    \titleformat{\section}[block]
        {}
        {}
        {0pt}
        {\mf@simpletitle{\arabic{section}}}
        []
\fi\fi

% ç›®å½•æ·±åº¦
\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{3}


% ---------------------------------------------------------
% 7. è®¡æ•°å™¨ä¸ç¼–å·è®¾ç½®
% ---------------------------------------------------------
\ifmf@chapnum
    % æŒ‰ç« èŠ‚ç¼–å·
    \ifmf@book
        \counterwithin{equation}{chapter}
        \counterwithin{figure}{chapter}
        \counterwithin{table}{chapter}
    \else
        \counterwithin{equation}{section}
        \counterwithin{figure}{section}
        \counterwithin{table}{section}
    \fi
\fi


% ---------------------------------------------------------
% 8. å›¾è¡¨å…¬å¼æ ·å¼
% ---------------------------------------------------------
\setkeys{Gin}{draft=false}

% æµ®åŠ¨ä½“å‚æ•°ä¼˜åŒ–
\renewcommand{\topfraction}{0.85}
\renewcommand{\bottomfraction}{0.70}
\renewcommand{\textfraction}{0.10}
\renewcommand{\floatpagefraction}{0.50}

% Caption æ ·å¼
\DeclareCaptionFont{heiti}{\heiti}
\DeclareCaptionFont{fivehao}{\zihao{5}}
\captionsetup{
    format=hang,
    labelsep=quad,
    font={fivehao,heiti},
    labelfont={fivehao,heiti},
    textfont={fivehao,heiti},
    skip=6pt
}
\captionsetup[sub]{labelformat=simple}

% é•¿è¡¨æ ¼æ ‡é¢˜å®½åº¦
\AtBeginEnvironment{longtable}{\setlength{\LTcapwidth}{\textwidth}}
\AtBeginEnvironment{xltabular}{\setlength{\LTcapwidth}{\textwidth}}

% ç¼–å·æ ¼å¼
\renewcommand\thesubfigure{(\alph{subfigure})}
\ifmf@chapnum
    \ifmf@book
        \renewcommand{\theequation}{\thechapter-\arabic{equation}}
        \renewcommand{\thefigure}{\thechapter-\arabic{figure}}
        \renewcommand{\thetable}{\thechapter-\arabic{table}}
    \else
        \renewcommand{\theequation}{\thesection-\arabic{equation}}
        \renewcommand{\thefigure}{\thesection-\arabic{figure}}
        \renewcommand{\thetable}{\thesection-\arabic{table}}
    \fi
\fi

% å¼•ç”¨æ ¼å¼
\labelformat{figure}{å›¾~#1}
\labelformat{table}{è¡¨~#1}
\labelformat{equation}{å¼~(#1)}

% ç¬¦å·é‡å®šä¹‰
\renewcommand{\leq}{\leqslant}
\renewcommand{\geq}{\geqslant}


% ---------------------------------------------------------
% 9. æ•°å­¦å®šç†ç¯å¢ƒ
% ---------------------------------------------------------
% å®šç†æ ·å¼
\theoremstyle{plain}
\ifmf@book
    \newtheorem{theorem}{å®šç†}[chapter]
\else\ifmf@chapnum
    \newtheorem{theorem}{å®šç†}[section]
\else
    \newtheorem{theorem}{å®šç†}
\fi\fi

\newtheorem{lemma}[theorem]{å¼•ç†}
\newtheorem{proposition}[theorem]{å‘½é¢˜}
\newtheorem{corollary}[theorem]{æ¨è®º}

% å®šä¹‰æ ·å¼
\theoremstyle{definition}
\ifmf@book
    \newtheorem{defn}{å®šä¹‰}[chapter]
    \newtheorem{example}{ä¾‹}[chapter]
\else\ifmf@chapnum
    \newtheorem{defn}{å®šä¹‰}[section]
    \newtheorem{example}{ä¾‹}[section]
\else
    \newtheorem{defn}{å®šä¹‰}
    \newtheorem{example}{ä¾‹}
\fi\fi

% æ³¨è®°æ ·å¼
\theoremstyle{remark}
\newtheorem*{remark}{æ³¨}
\newtheorem*{solution}{è§£}

% è¯æ˜ç¯å¢ƒæ±‰åŒ–
\renewcommand{\proofname}{è¯æ˜}


% ---------------------------------------------------------



% ---------------------------------------------------------
% 10. æ•°å­¦ä¸æ·±åº¦å­¦ä¹ ä¸“ç”¨å®
% ---------------------------------------------------------

% [10.1] åŸºç¡€å¾®ç§¯åˆ†ä¸åˆ†æ
% physics åŒ…å·²æä¾› \dd (å¾®åˆ†) å’Œ \grad (æ¢¯åº¦)ï¼Œæ­¤å¤„ä¸å†é‡å¤å®šä¹‰
% \dd ä¼šè‡ªåŠ¨å¤„ç†é—´è·ï¼Œå¦‚ \dd x
\newcommand{\dx}{\,\dd x}
\newcommand{\dy}{\,\dd y}
\newcommand{\dz}{\,\dd z}
\newcommand{\dt}{\,\dd t}
\newcommand{\ds}{\,\dd s}
\newcommand{\dw}{\,\dd w}
\newcommand{\dtau}{\,\dd \tau}
\newcommand{\dm}{\,\dd m}
\newcommand{\dmu}{\,\dd \mu}

% ç®—å­
\newcommand{\pd}[2]{\frac{\partial #1}{\partial #2}}     % åå¯¼
\newcommand{\pdd}[2]{\frac{\partial^2 #1}{\partial #2^2}} % äºŒé˜¶åå¯¼
% \grad å·²ç”± physics æä¾› (\nabla)
\let\div\relax \DeclareMathOperator{\div}{div}        % æ•£åº¦
\let\curl\relax \DeclareMathOperator{\curl}{curl}     % æ—‹åº¦ (é‡å®šä¹‰ä¸º textual operator)
\DeclareMathOperator{\lap}{\Delta}                     % æ‹‰æ™®æ‹‰æ–¯
\DeclareMathOperator{\supp}{supp}                      % æ”¯é›†
\DeclareMathOperator{\dist}{dist}                      % è·ç¦»
\DeclareMathOperator{\diam}{diam}                      % ç›´å¾„
\DeclareMathOperator*{\argmin}{arg\,min}               % argmin
\DeclareMathOperator*{\argmax}{arg\,max}               % argmax

% æé™ä¸æ”¶æ•›
\newcommand{\limn}{\lim_{n\to\infty}}
\newcommand{\limk}{\lim_{k\to\infty}}
\newcommand{\limx}[1][0]{\lim_{x\to #1}}
\newcommand{\weakto}{\rightharpoonup}                  % å¼±æ”¶æ•›
\newcommand{\embeds}{\hookrightarrow}                  % åµŒå…¥
\newcommand{\compactembeds}{\subset\subset}            % ç´§åµŒå…¥

% å¸¸ç”¨ç§¯åˆ†
\newcommand{\intR}{\int_{\R}}
\newcommand{\intRn}{\int_{\R^n}}
\newcommand{\intO}{\int_\Omega}
\newcommand{\intpO}{\int_{\partial\Omega}}

% å‡½æ•°ç©ºé—´
\newcommand{\Cinf}{C^\infty}
\newcommand{\Cc}{C_c^\infty}                           % ç´§æ”¯é›†å…‰æ»‘å‡½æ•°
\newcommand{\Lp}[1][p]{L^{#1}}                         % Lp ç©ºé—´
\newcommand{\Wkp}[2]{W^{#1,#2}}                        % Sobolev ç©ºé—´ W^{k,p}
\newcommand{\Hk}[1][1]{H^{#1}}                         % Hilbert ç©ºé—´ H^k
\newcommand{\normL}[2][p]{\norm{#2}_{L^{#1}}}          % Lp èŒƒæ•°

% [10.2] é›†åˆä¸é€»è¾‘
\newcommand{\set}[1]{\{#1\}}
\newcommand{\Set}[1]{\left\{#1\right\}}
\newcommand{\st}{\;|\;}                                % such that
\newcommand{\lra}{\Longleftrightarrow}                 % ç­‰ä»·
\newcommand{\ra}{\Longrightarrow}                      % æ¨å‡º

% [10.3] æ·±åº¦å­¦ä¹ æ‰©å±•
% æŸå¤±å‡½æ•°
\newcommand{\loss}{\ensuremath{\mathcal{L}}}           % æŸå¤±å‡½æ•°
\DeclareMathOperator{\MSE}{MSE}
\DeclareMathOperator{\CE}{CE}
\DeclareMathOperator{\BCE}{BCE}
\DeclareMathOperator{\KLdiv}{KL}

% æ•°æ®ä¸æ¨¡å‹
\newcommand{\data}{\ensuremath{\mathcal{D}}}           % æ•°æ®é›†
\newcommand{\model}{\ensuremath{\mathcal{M}}}          % æ¨¡å‹
\newcommand{\param}{\ensuremath{\bm{\theta}}}          % å‚æ•°å‘é‡
\newcommand{\weight}{\ensuremath{\bm{W}}}              % æƒé‡çŸ©é˜µ
\newcommand{\bias}{\ensuremath{\bm{b}}}                % åç½®å‘é‡

% æ¦‚ç‡ä¸æœŸæœ›
\DeclareMathOperator*{\expect}{\mathbb{E}}             % æœŸæœ›
\newcommand{\prob}{\ensuremath{\mathbb{P}}}            % æ¦‚ç‡
\DeclareMathOperator{\Var}{Var}                        % æ–¹å·®
\DeclareMathOperator{\Cov}{Cov}                        % åæ–¹å·®

% æ¿€æ´»å‡½æ•°
\DeclareMathOperator{\relu}{ReLU}
\newcommand{\sigmoid}{\ensuremath{\sigma}}
\DeclareMathOperator{\softmax}{softmax}
\DeclareMathOperator{\tanhfunc}{tanh}

% ç½‘ç»œå±‚
\newcommand{\LSTM}{\mathrm{LSTM}}
\newcommand{\GRU}{\mathrm{GRU}}
\newcommand{\Conv}{\mathrm{Conv}}
\newcommand{\Pool}{\mathrm{Pool}}
\newcommand{\BatchNorm}{\mathrm{BatchNorm}}
\newcommand{\Dropout}{\mathrm{Dropout}}

% å‘é‡ä¸çŸ©é˜µ
\newcommand{\vect}[1]{\ensuremath{\bm{#1}}}            % å‘é‡
\newcommand{\mat}[1]{\ensuremath{\bm{#1}}}             % çŸ©é˜µ
\newcommand{\tensor}[1]{\ensuremath{\mathcal{#1}}}     % å¼ é‡

% [10.4] å¸¸ç”¨é›†åˆ
\newcommand{\R}{\ensuremath{\mathbb{R}}}               % å®æ•°é›†
\newcommand{\N}{\ensuremath{\mathbb{N}}}               % è‡ªç„¶æ•°é›†
\newcommand{\Z}{\ensuremath{\mathbb{Z}}}               % æ•´æ•°é›†
\newcommand{\Q}{\ensuremath{\mathbb{Q}}}               % æœ‰ç†æ•°é›†
\newcommand{\C}{\ensuremath{\mathbb{C}}}               % å¤æ•°é›†


% ---------------------------------------------------------
% 11. PDF å±æ€§è®¾ç½®
% ---------------------------------------------------------
\hypersetup{
    hidelinks,
    colorlinks=false,
    bookmarksnumbered=true,
    bookmarksopen=true,
    pdfstartview=FitH
}

\AtBeginDocument{
    \hypersetup{
        pdftitle={\@title},
        pdfauthor={\@author},
        pdfsubject={Math \& Deep Learning Notes},
        pdfcreator={MindFlow LaTeX Class}
    }
}


% ---------------------------------------------------------
% 12. é«˜çº§å›¾æ–‡æ··æ’ç¯å¢ƒ
% ---------------------------------------------------------
% [12.1] å›¾æ–‡æ··æ’ç¯å¢ƒ (textfigure)
\newsavebox{\tf@textbox}
\newlength{\tf@imagew}
\newlength{\tf@textw}
\def\tf@left{left}

\NewDocumentEnvironment{textfigure}{O{right} m m O{0.4}}{%
    \def\tf@pos{#1}%
    \def\tf@path{#2}%
    \def\tf@cap{#3}%
    \setlength{\tf@imagew}{#4\textwidth}%
    \setlength{\tf@textw}{\textwidth}%
    \addtolength{\tf@textw}{-\tf@imagew}%
    \addtolength{\tf@textw}{-1.5em}%
    \begin{lrbox}{\tf@textbox}%
        \begin{minipage}{\tf@textw}%
            \setlength{\parindent}{2em}%
            \linespread{1.5}\selectfont%
}{%
        \end{minipage}%
    \end{lrbox}%
    \par\vspace{1em}\noindent
    \ifx\tf@pos\tf@left
        \begin{minipage}[c]{\tf@imagew}
            \centering
            \includegraphics[width=\linewidth]{\tf@path}
            \captionsetup{hypcap=false}%
            \captionof{figure}{\tf@cap}
        \end{minipage}%
        \hfill
        \usebox{\tf@textbox}
    \else
        \usebox{\tf@textbox}%
        \hfill
        \begin{minipage}[c]{\tf@imagew}
            \centering
            \includegraphics[width=\linewidth]{\tf@path}
            \captionsetup{hypcap=false}%
            \captionof{figure}{\tf@cap}
        \end{minipage}
    \fi
    \par\vspace{1em}
}

% [12.2] å¹¶è¡Œå›¾ç‰‡ç¯å¢ƒ (parallelfigures)
\newcommand{\pf@maincap}{}
\NewDocumentEnvironment{parallelfigures}{m}{%
    \renewcommand{\pf@maincap}{#1}%
    \begin{figure}[H]
        \centering
        \newcommand{\addfig}[3][0.48]{%
            \begin{subfigure}[b]{##1\textwidth}
                \centering
                \includegraphics[width=\linewidth]{##2}
                \caption{##3}
            \end{subfigure}%
            \hspace{\fill}%
        }%
}{%
        \caption{\pf@maincap}%
    \end{figure}%
}

% [12.3] å¤šå›¾è¡Œç¯å¢ƒ (figurerow)
\newcommand{\fr@maincap}{}
\newcommand{\fr@cols}{2}
\NewDocumentEnvironment{figurerow}{m O{2}}{%
    \renewcommand{\fr@maincap}{#1}%
    \renewcommand{\fr@cols}{#2}%
    \begin{figure}[H]
        \centering
        \newlength{\fr@width}%
        \setlength{\fr@width}{\dimexpr(\textwidth-1em*#2)/#2\relax}%
        \newcommand{\figitem}[2]{%
            \begin{subfigure}[b]{\fr@width}
                \centering
                \includegraphics[width=\linewidth]{##1}
                \caption{##2}
            \end{subfigure}\hfill
        }%
}{%
        \caption{\fr@maincap}
    \end{figure}
}

% [12.4] ç½‘æ ¼å›¾ç‰‡ç¯å¢ƒ (figuregrid)
\newcommand{\fg@maincap}{}
\NewDocumentEnvironment{figuregrid}{m}{%
    \renewcommand{\fg@maincap}{#1}%
    \begin{figure}[H]
        \centering
        \newcommand{\gridrow}[1]{%
            ##1\par\vspace{0.5em}%
        }%
        \newcommand{\gridfig}[3][0.48]{%
            \begin{subfigure}[b]{##1\textwidth}
                \centering
                \includegraphics[width=\linewidth]{##2}
                \caption{##3}
            \end{subfigure}\hfill
        }%
}{%
        \caption{\fg@maincap}
    \end{figure}
}


% ---------------------------------------------------------
% 13. ä»£ç ç¯å¢ƒé…ç½®
% ---------------------------------------------------------
\RequirePackage{listings}
\RequirePackage[most,listings,xparse,breakable]{tcolorbox}

% ---------------------------------------------------------
% 13.0 ç¾åŒ–å®šç†ç¯å¢ƒ (tcolorbox ç‰ˆæœ¬)
% ---------------------------------------------------------
% ğŸ’¡ è¯´æ˜ï¼šä»¥ä¸‹ *new ç¯å¢ƒä¸åŸç¯å¢ƒå…±äº«è®¡æ•°å™¨ï¼Œæä¾›ç²¾ç¾çš„å¯è§†åŒ–æ•ˆæœ
% ç¼–å·æ ¼å¼ç»Ÿä¸€ä¸º section-ç¼–å· (æˆ– chapter-ç¼–å· åœ¨ book æ¨¡å¼ä¸‹)

% === é…è‰²æ–¹æ¡ˆ ===
\definecolor{mf@thm@blue}{RGB}{30,90,150}      % å®šç†è“
\definecolor{mf@thm@bluebg}{RGB}{235,245,255}  % å®šç†èƒŒæ™¯
\definecolor{mf@lem@teal}{RGB}{0,128,128}      % å¼•ç†é’
\definecolor{mf@lem@tealbg}{RGB}{230,250,250}  % å¼•ç†èƒŒæ™¯
\definecolor{mf@prop@purple}{RGB}{100,50,150}  % å‘½é¢˜ç´«
\definecolor{mf@prop@purplebg}{RGB}{245,235,255} % å‘½é¢˜èƒŒæ™¯
\definecolor{mf@cor@orange}{RGB}{200,100,0}    % æ¨è®ºæ©™
\definecolor{mf@cor@orangebg}{RGB}{255,245,230} % æ¨è®ºèƒŒæ™¯
\definecolor{mf@def@green}{RGB}{0,100,60}      % å®šä¹‰ç»¿
\definecolor{mf@def@greenbg}{RGB}{235,250,240} % å®šä¹‰èƒŒæ™¯
\definecolor{mf@ex@brown}{RGB}{150,80,40}      % ä¾‹é¢˜æ£•
\definecolor{mf@ex@brownbg}{RGB}{255,250,240}  % ä¾‹é¢˜èƒŒæ™¯
\definecolor{mf@rem@gray}{RGB}{80,80,80}       % æ³¨è®°ç°
\definecolor{mf@rem@graybg}{RGB}{245,245,245}  % æ³¨è®°èƒŒæ™¯
\definecolor{mf@prf@darkblue}{RGB}{40,60,100}  % è¯æ˜æ·±è“
\definecolor{mf@prf@darkbluebg}{RGB}{248,250,255} % è¯æ˜èƒŒæ™¯

% === åŸºç¡€æ ·å¼æ¨¡æ¿ ===
\tcbset{
    mf@thmbase/.style={
        enhanced,
        breakable,
        sharp corners,
        boxrule=0pt,
        left=10pt,
        right=10pt,
        top=22pt,           % ğŸ’¡ å¢åŠ é¡¶éƒ¨å†…è¾¹è·ï¼Œä¸ºæ ‡é¢˜æ¡†ç•™å‡ºç©ºé—´
        bottom=10pt,
        before skip=20pt,
        after skip=20pt,
        fonttitle=\bfseries\heiti,
        separator sign={~},
        description font=\normalfont\heiti,
        description delimiters parenthesis,
        terminator sign={.},
    },
    mf@thmframe/.style={
        mf@thmbase,
        borderline west={3pt}{0pt}{#1},
        colback=#1!8!white,
        coltitle=#1,
        colbacktitle=white,
        attach boxed title to top left={xshift=10pt, yshift=-\tcboxedtitleheight/2-2pt},
        boxed title style={
            colback=white,
            colframe=#1,
            boxrule=1pt,
            arc=3pt,
            left=5pt,
            right=5pt,
            top=3pt,
            bottom=3pt
        }
    }
}

% === theoremnew: å®šç† (è“è‰²) ===
\newtcolorbox[use counter=theorem, number within=section]{theoremnew}[2][]{
    mf@thmframe=mf@thm@blue,
    colback=mf@thm@bluebg,
    title={å®šç†~\thetcbcounter\ifblank{#2}{}{~(#2)}},
    #1
}

% === lemmanew: å¼•ç† (é’è‰²) ===
\newtcolorbox[use counter=theorem]{lemmanew}[2][]{
    mf@thmframe=mf@lem@teal,
    colback=mf@lem@tealbg,
    title={å¼•ç†~\thetcbcounter\ifblank{#2}{}{~(#2)}},
    #1
}

% === propositionnew: å‘½é¢˜ (ç´«è‰²) ===
\newtcolorbox[use counter=theorem]{propositionnew}[2][]{
    mf@thmframe=mf@prop@purple,
    colback=mf@prop@purplebg,
    title={å‘½é¢˜~\thetcbcounter\ifblank{#2}{}{~(#2)}},
    #1
}

% === corollarynew: æ¨è®º (æ©™è‰²) ===
\newtcolorbox[use counter=theorem]{corollarynew}[2][]{
    mf@thmframe=mf@cor@orange,
    colback=mf@cor@orangebg,
    title={æ¨è®º~\thetcbcounter\ifblank{#2}{}{~(#2)}},
    #1
}

% === defnnew: å®šä¹‰ (ç»¿è‰²) ===
\newtcolorbox[use counter=defn, number within=section]{defnnew}[2][]{
    mf@thmframe=mf@def@green,
    colback=mf@def@greenbg,
    title={å®šä¹‰~\thetcbcounter\ifblank{#2}{}{~(#2)}},
    #1
}

% === examplenew: ä¾‹ (æ£•è‰²) ===
\newtcolorbox[use counter=example, number within=section]{examplenew}[2][]{
    mf@thmframe=mf@ex@brown,
    colback=mf@ex@brownbg,
    title={ä¾‹~\thetcbcounter\ifblank{#2}{}{~(#2)}},
    #1
}

% === remarknew: æ³¨ (ç°è‰²ï¼Œæ— ç¼–å·) ===
\newtcolorbox{remarknew}[1][]{
    mf@thmbase,
    borderline west={2pt}{0pt}{mf@rem@gray},
    colback=mf@rem@graybg,
    coltitle=mf@rem@gray,
    fonttitle=\bfseries\heiti,
    title={æ³¨},
    #1
}

% === proofnew: è¯æ˜ (æ·±è“è‰²ï¼Œæ— ç¼–å·) ===
\newtcolorbox{proofnew}[1][]{
    mf@thmbase,
    borderline west={2pt}{0pt}{mf@prf@darkblue},
    colback=mf@prf@darkbluebg,
    coltitle=mf@prf@darkblue,
    fonttitle=\bfseries\heiti,
    title={è¯æ˜},
    after upper={\hfill$\square$},
    #1
}

% === solutionnew: è§£ (ä¸è¯æ˜ç±»ä¼¼) ===
\newtcolorbox{solutionnew}[1][]{
    mf@thmbase,
    borderline west={2pt}{0pt}{mf@ex@brown},
    colback=mf@ex@brownbg,
    coltitle=mf@ex@brown,
    fonttitle=\bfseries\heiti,
    title={è§£},
    #1
}

% [13.1] è®¡æ•°å™¨
\newcounter{mfcode}[section]
\renewcommand{\themfcode}{\thesection-\arabic{mfcode}}

% [13.2] é…è‰² (VSCode Light)
\definecolor{mf@codeback}{RGB}{250,250,250}
\definecolor{mf@codeframe}{RGB}{220,220,220}
\definecolor{mf@keyword}{RGB}{0,92,197}
\definecolor{mf@comment}{RGB}{80,161,79}
\definecolor{mf@string}{RGB}{227,17,108}
\definecolor{mf@number}{RGB}{160,160,160}

% [13.3] listings æ ·å¼
\lstdefinestyle{mfstyle}{
    basicstyle=\small\ttfamily,
    keywordstyle=\bfseries\color{mf@keyword},
    commentstyle=\itshape\color{mf@comment},
    stringstyle=\color{mf@string},
    numberstyle=\tiny\color{mf@number},
    numbers=left,
    numbersep=10pt,
    stepnumber=1,
    breaklines=true,
    breakatwhitespace=false,
    showstringspaces=false,
    showtabs=false,
    captionpos=b,
    frame=none,
    extendedchars=false,
    escapechar=,
    upquote=true,
    tabsize=4,
    keepspaces=true,
    mathescape=false,
    texcl=false,
    columns=flexible
}

% [13.4] tcolorbox æ ·å¼ (Mac é£æ ¼)
\tcbset{
    mfcodestyle/.style={
        enhanced,
        breakable,
        colback=mf@codeback,
        colframe=mf@codeframe,
        listing only,
        title={\textbf{ä»£ç  \themfcodeï¼š}#1},
        coltitle=black,
        fonttitle=\bfseries\heiti\small,
        attach boxed title to top center={yshift=-3mm},
        boxed title style={
            colback=white,
            colframe=mf@codeframe,
            boxrule=0.5pt,
            arc=3pt,
            drop shadow
        },
        sharp corners,
        rounded corners=southeast,
        arc=5pt,
        top=12pt, bottom=2pt, left=6pt, right=6pt,
        boxrule=0.8pt,
        drop shadow,
        overlay unbroken and first={
            \draw[fill=red!70!white, draw=none] ([xshift=6mm,yshift=-1.5mm]frame.north west) circle (2.5pt);
            \draw[fill=yellow!70!white, draw=none] ([xshift=11mm,yshift=-1.5mm]frame.north west) circle (2.5pt);
            \draw[fill=green!70!white, draw=none] ([xshift=16mm,yshift=-1.5mm]frame.north west) circle (2.5pt);
        }
    }
}

% [13.5] codeblock ç¯å¢ƒ
\newtcblisting{codeblock}[2][c]{
    mfcodestyle={#2},
    listing engine=listings,
    listing options={style=mfstyle, language=#1},
    code={\refstepcounter{mfcode}}
}

% [13.6] filecode å‘½ä»¤
\NewDocumentCommand{\filecode}{O{c} m m}{%
    \refstepcounter{mfcode}%
    \tcbinputlisting{
        mfcodestyle={#2},
        listing engine=listings,
        listing file={#3},
        listing options={style=mfstyle, language=#1}
    }%
}


% ---------------------------------------------------------
% 14. æç¤ºæ¡†ç¯å¢ƒ
% ---------------------------------------------------------
\tcbset{
    commonbox/.style={
        enhanced,
        breakable,
        sharp corners,
        rounded corners=southeast,
        arc=4pt,
        boxrule=1pt,
        drop shadow,
        attach boxed title to top left={yshift=-2mm, xshift=5mm},
        boxed title style={boxrule=0pt, colframe=white, colback=white},
        fonttitle=\bfseries\heiti,
        top=12pt
    }
}

% æ³¨æ„æ¡† (è“è‰²)
\newtcolorbox{notice}[1]{
    commonbox,
    colback=Azure1,
    colframe=DodgerBlue3,
    coltitle=DodgerBlue3,
    title={ã€æ³¨æ„ã€‘#1}
}

% å®šä¹‰æ¡† (ç»¿è‰²) - æ³¨æ„ä¸ defn å®šç†ç¯å¢ƒåŒºåˆ†
\newtcolorbox{defbox}[1]{
    commonbox,
    colback=Honeydew1,
    colframe=ForestGreen,
    coltitle=ForestGreen,
    title={ã€å®šä¹‰ã€‘#1}
}

% ç»“è®ºæ¡† (çº¢è‰²)
\newtcolorbox{conclusion}[1]{
    commonbox,
    colback=LavenderBlush1,
    colframe=Crimson,
    coltitle=Crimson,
    title={ã€ç»“è®ºã€‘#1}
}

% æŠ€å·§æ¡† (ç´«è‰²)
\newtcolorbox{tip}[1]{
    commonbox,
    colback=Lavender,
    colframe=DarkOrchid,
    coltitle=DarkOrchid,
    title={ã€æŠ€å·§ã€‘#1}
}

% è­¦å‘Šæ¡† (æ©™è‰²)
\newtcolorbox{warning}[1]{
    commonbox,
    colback=LemonChiffon,
    colframe=DarkOrange,
    coltitle=DarkOrange,
    title={ã€è­¦å‘Šã€‘#1}
}


% ---------------------------------------------------------
% 15. åˆ—è¡¨ç¯å¢ƒä¼˜åŒ–
% ---------------------------------------------------------
\RequirePackage{amssymb}

% ç»˜å›¾æ ‡å·
\newcommand{\mf@item@square}{%
    \tikz[baseline=-0.6ex] \node[fill=black, shape=rectangle, inner sep=0pt, minimum size=0.5em] {};%
}
\newcommand{\mf@item@circle}{%
    \tikz[baseline=-0.6ex] \node[fill=darkgray, shape=circle, inner sep=0pt, minimum size=0.35em] {};%
}
\newcommand{\mf@item@dash}{%
    \tikz[baseline=-0.6ex] \draw[line width=0.8pt] (0,0) -- (0.5em,0);%
}
\newcommand{\mf@circled}[1]{%
    \begin{tikzpicture}[baseline=(char.base)]
        \node[shape=circle, draw=black, inner sep=0.5pt, minimum size=1.2em, line width=0.6pt] (char) {\small\bfseries #1};
    \end{tikzpicture}%
}
\newcommand{\mf@squared}[1]{%
    \begin{tikzpicture}[baseline=(char.base)]
        \node[shape=rectangle, draw=black, fill=black, text=white, rounded corners=2pt, inner sep=1pt, minimum size=1.2em] (char) {\small\bfseries #1};
    \end{tikzpicture}%
}

% å…¨å±€åˆ—è¡¨è®¾ç½®
\setlist{
    nosep,
    itemsep=3pt,
    parsep=0pt,
    topsep=4pt,
    partopsep=0pt
}

% æ— åºåˆ—è¡¨
\setlist[itemize,1]{label=\protect\mf@item@square, leftmargin=2.0em, labelsep=0.6em}
\setlist[itemize,2]{label=\protect\mf@item@circle, leftmargin=1.8em, labelsep=0.6em}
\setlist[itemize,3]{label=\protect\mf@item@dash, leftmargin=1.8em, labelsep=0.6em}

% æœ‰åºåˆ—è¡¨
\setlist[enumerate,1]{label=\arabic*., leftmargin=2.0em, labelsep=0.5em}
\setlist[enumerate,2]{label=(\arabic*), leftmargin=2.0em, labelsep=0.5em}

% è‡ªå®šä¹‰æ ·å¼
\newlist{enumpar}{enumerate}{1}
\setlist[enumpar]{label=(\arabic*), leftmargin=2.5em, labelsep=0.5em, itemsep=2pt, align=left}

\newlist{enumbra}{enumerate}{1}
\setlist[enumbra]{label=\arabic*), leftmargin=2.5em, labelsep=0.5em, itemsep=2pt, align=left}

\newlist{enumcircled}{enumerate}{1}
\setlist[enumcircled]{label=\protect\mf@circled{\arabic*}, leftmargin=2.8em, labelsep=0.6em, itemsep=3pt}

\newlist{enumsquared}{enumerate}{1}
\setlist[enumsquared]{label=\protect\mf@squared{\arabic*}, leftmargin=2.8em, labelsep=0.6em, itemsep=3pt}


% ---------------------------------------------------------
% 16. å¯¼è¯»ä¸æ€»ç»“ç¯å¢ƒ
% ---------------------------------------------------------

% é…è‰²
\definecolor{mf@intro@frame}{RGB}{100, 100, 180} % æ·¡é›è“
\definecolor{mf@intro@bg}{RGB}{245, 245, 255}
\definecolor{mf@sum@frame}{RGB}{60, 140, 100}   % æ·±æµ·ç»¿
\definecolor{mf@sum@bg}{RGB}{245, 255, 248}

% å¯¼è¯»ç¯å¢ƒ (Intro)
\newtcolorbox{introbox}[1][æœ¬ç« å¯¼è¯»]{
    enhanced,
    colback=mf@intro@bg,
    colframe=mf@intro@frame,
    fonttitle=\bfseries\heiti\large,
    coltitle=white,
    title={#1},
    attach boxed title to top left={xshift=20pt, yshift*=-\tcboxedtitleheight/2},
    boxed title style={
        colback=mf@intro@frame,
        frame hidden,
        arc=4pt,
        rounded corners,
    },
    drop shadow,
    arc=6pt,
    before skip=15pt,
    after skip=15pt,
    overlay={
        \node[anchor=north east, opacity=0.1] at ([xshift=-10pt, yshift=-5pt]frame.north east) {\Huge\itshape i};
    }
}

% æ€»ç»“ç¯å¢ƒ (Summary)
\newtcolorbox{summarybox}[1][æœ¬ç« å°ç»“]{
    enhanced,
    colback=mf@sum@bg,
    colframe=mf@sum@frame,
    fonttitle=\bfseries\heiti\large,
    coltitle=white,
    title={#1},
    attach boxed title to top right={xshift=-20pt, yshift*=-\tcboxedtitleheight/2},
    boxed title style={
        colback=mf@sum@frame,
        frame hidden,
        arc=4pt,
        rounded corners,
    },
    drop shadow,
    arc=6pt,
    before skip=15pt,
    after skip=15pt
}


% ---------------------------------------------------------
% 16. æ‰¹æ³¨ç³»ç»Ÿ
% ---------------------------------------------------------
\tcbset{
    mf@todostyle/.style={
        enhanced,
        breakable,
        width=\textwidth,
        sharp corners,
        rounded corners=southeast,
        arc=3pt,
        boxrule=1pt,
        left=4pt, right=4pt, top=2pt, bottom=2pt,
        before skip=8pt, after skip=8pt,
        fonttitle=\bfseries\small,
        attach boxed title to top left={yshift=-2mm, xshift=3mm},
        boxed title style={boxrule=0pt, colframe=white}
    }
}

% TODO å¾…åŠ
\newcommand{\todo}[1]{%
    \begin{tcolorbox}[
        mf@todostyle,
        colback=orange!5,
        colframe=orange!80!black,
        coltitle=orange!80!black,
        boxed title style={colback=orange!10},
        title={TODO (å¾…åŠ)}
    ]
        #1
    \end{tcolorbox}%
}

% FIXME éœ€ä¿®æ­£
\newcommand{\fixme}[1]{%
    \begin{tcolorbox}[
        mf@todostyle,
        colback=red!5,
        colframe=red!75!black,
        coltitle=red!75!black,
        boxed title style={colback=red!10},
        title={FIXME (éœ€ä¿®æ­£)}
    ]
        #1
    \end{tcolorbox}%
}

% NOTE å¤‡æ³¨
\newcommand{\notebox}[1]{%
    \begin{tcolorbox}[
        mf@todostyle,
        colback=blue!5,
        colframe=blue!65!black,
        coltitle=blue!65!black,
        boxed title style={colback=blue!10},
        title={NOTE (å¤‡æ³¨)}
    ]
        #1
    \end{tcolorbox}%
}


% ---------------------------------------------------------
% 17. æ•™ç¨‹å±•ç¤ºç¯å¢ƒ
% ---------------------------------------------------------
\definecolor{mf@demo@codebg}{RGB}{248,248,248}
\definecolor{mf@demo@resultbg}{RGB}{255,255,245}
\definecolor{mf@demo@frame}{RGB}{200,200,200}
\definecolor{mf@api@bg}{RGB}{240,248,255}
\definecolor{mf@api@frame}{RGB}{70,130,180}

% ä»£ç å±•ç¤ºæ ·å¼
\lstdefinestyle{demostyle}{
    basicstyle=\small\ttfamily,
    keywordstyle=\bfseries\color{mf@keyword},
    commentstyle=\itshape\color{mf@comment},
    stringstyle=\color{mf@string},
    backgroundcolor=\color{mf@demo@codebg},
    frame=none,
    breaklines=true,
    showstringspaces=false,
    tabsize=2,
    columns=flexible,
    keepspaces=true,
    extendedchars=false,
    texcl=false,
    mathescape=false
}

% democode ç¯å¢ƒ
\newtcblisting{democode}[1]{
    enhanced,
    breakable,
    title={#1},
    fonttitle=\bfseries\heiti,
    coltitle=black,
    colbacktitle=gray!15,
    colframe=mf@demo@frame,
    boxrule=0.8pt,
    arc=3pt,
    listing engine=listings,
    listing options={style=demostyle},
    sidebyside,
    sidebyside align=top,
    lefthand ratio=0.5,
    righthand width=0.46\linewidth,
    colback=mf@demo@codebg,
    segmentation style={solid, mf@demo@frame},
    bicolor,
    colbacklower=mf@demo@resultbg,
    left=3pt, right=3pt, top=2pt, bottom=2pt,
    middle=3pt
}

% demovert ç¯å¢ƒ
\newtcblisting{demovert}[1]{
    enhanced,
    breakable,
    title={#1},
    fonttitle=\bfseries\heiti,
    coltitle=black,
    colbacktitle=gray!15,
    colframe=mf@demo@frame,
    boxrule=0.8pt,
    arc=3pt,
    listing engine=listings,
    listing options={style=demostyle},
    listing and text,
    colback=mf@demo@codebg,
    segmentation style={solid, mf@demo@frame},
    bicolor,
    colbacklower=mf@demo@resultbg,
    left=5pt, right=5pt, top=3pt, bottom=3pt,
    middle=3pt
}

% codeonly ç¯å¢ƒ
\newtcblisting{codeonly}[1]{
    enhanced,
    breakable,
    title={#1},
    fonttitle=\bfseries\heiti,
    coltitle=black,
    colbacktitle=gray!15,
    colframe=mf@demo@frame,
    colback=mf@demo@codebg,
    boxrule=0.8pt,
    arc=3pt,
    listing engine=listings,
    listing options={style=demostyle},
    listing only,
    left=5pt, right=5pt, top=3pt, bottom=3pt
}

% API å¡ç‰‡
\newcommand{\apibox}[3]{%
    \begin{tcolorbox}[
        enhanced,
        colback=mf@api@bg,
        colframe=mf@api@frame,
        boxrule=1pt,
        arc=4pt,
        left=8pt, right=8pt, top=6pt, bottom=6pt,
        fonttitle=\bfseries\ttfamily,
        title={\textbackslash #1},
        coltitle=white,
        colbacktitle=mf@api@frame,
        attach boxed title to top left={xshift=5mm, yshift=-3mm},
        boxed title style={arc=2pt, boxrule=0pt}
    ]
    \textbf{å‚æ•°ï¼š} \texttt{#2} \\[3pt]
    \textbf{è¯´æ˜ï¼š} #3
    \end{tcolorbox}
}

% é€‰é¡¹åˆ—è¡¨
\newenvironment{optionlist}{%
    \par\vspace{0.5em}%
    \noindent%
}{%
    \par\vspace{0.5em}%
}

\newcommand{\option}[2]{%
    \noindent\hspace{1em}%
    \texttt{\bfseries\color{mf@api@frame}#1}%
    \hspace{0.5em}---\hspace{0.5em}#2%
    \par\vspace{0.3em}%
}

% è¡Œå†…ä»£ç å‘½ä»¤
\newcommand{\cmd}[1]{\texttt{\textbackslash #1}}
\newcommand{\env}[1]{\texttt{#1}}
\newcommand{\opt}[1]{\texttt{[#1]}}


% ---------------------------------------------------------
% 18. é™„å½•ç¯å¢ƒ
% ---------------------------------------------------------
\newenvironment{appendixblock}{
    \clearpage
    \phantomsection
    \addcontentsline{toc}{section}{é™„å½•}
    \setcounter{section}{0}
    \setcounter{subsection}{0}
    \renewcommand{\thesection}{\Alph{section}}
    \ctexset{
        section = {
            name = {é™„å½•,},
            number = \thesection,
            format = \centering\zihao{4}\heiti\bfseries
        }
    }
    \titlecontents{section}[0pt]
    {\addvspace{6pt}\bfseries\heiti\zihao{4}}
    {é™„å½•\thecontentslabel\quad}
    {}
    {\titlerule*[0.5pc]{.}\contentspage}
}{}


% ---------------------------------------------------------
% 19. å‚è€ƒæ–‡çŒ®
% ---------------------------------------------------------
\newcommand{\upcite}[1]{%
    \textsuperscript{\cite{#1}}%
}

\newcommand{\MyBibliography}[1]{
    \clearpage
    \phantomsection
    \addcontentsline{toc}{section}{å‚è€ƒæ–‡çŒ®}
    \renewcommand{\section}[2]{}%
    \bibliographystyle{plain}
    \bibliography{#1}
}


% ---------------------------------------------------------
% 20. ç›®å½•æ ‘
% ---------------------------------------------------------
\RequirePackage{dirtree}
\renewcommand{\DTstyle}{\ttfamily\small}


% [21.3] æœ¯è¯­è¡¨ (Nomenclature)
\RequirePackage[intoc]{nomencl}
\makenomenclature
\renewcommand{\nomname}{æœ¯è¯­ä¸ç¬¦å·è¡¨}
\setlength{\nomitemsep}{-\parsep} % ç´§å‡‘æ’åˆ—

% [21.4] åˆ†ç« å‚è€ƒæ–‡çŒ® (Chapterbib)
% ä»…åœ¨ book æ¨¡å¼ä¸‹ä¸”é review æ¨¡å¼æ¨èä½¿ç”¨
\ifmf@book
    \RequirePackage{chapterbib}
\fi

% [21.5] å¾½ç« ç³»ç»Ÿ (Badges)
\newcommand{\mfbadge}[3][mf@thm@blue]{%
    \tikz[baseline=(b.base)]{
        \node[inner sep=2pt, font=\sffamily\tiny\bfseries, text=white, fill=#1!80!black, rounded corners=2pt, anchor=west] (b) at (0,0) {#2\hspace{2pt}\vrule\hspace{2pt}#3};
    }%
}

% ä»¿ GitHub é£æ ¼ (å·¦ç°å³è“)
\newcommand{\ghbadge}[2]{%
    \tikz[baseline=(text.base)]{
        \node[fill=gray!30, inner sep=2pt, rounded corners=2pt, font=\tiny\sffamily] (label) at (0,0) {#1};
        \node[fill=mf@thm@blue, text=white, inner sep=2pt, rounded corners=2pt, font=\tiny\sffamily, anchor=west] (text) at (label.east) {\hspace{-2pt}#2};
    }%
}


% ---------------------------------------------------------
% 22. å­¦æœ¯å°é¢è®¾è®¡
% ---------------------------------------------------------
\newcommand{\subtitle}[1]{\gdef\@subtitle{#1}}
\newcommand{\advisor}[1]{\gdef\@advisor{#1}}
\newcommand{\institute}[1]{\gdef\@institute{#1}}
\newcommand{\version}[1]{\gdef\@version{#1}}
\newcommand{\coverdate}[1]{\gdef\@coverdate{#1}}

% é»˜è®¤å€¼
\gdef\@subtitle{}
\gdef\@advisor{}
\gdef\@institute{MindFlow Lab}
\gdef\@version{1.0}
\gdef\@coverdate{\today}

\newcommand{\makecover}{
    \begin{titlepage}
        \linespread{1.2}
        \begin{center}
            \vspace*{2cm}
            % æ ‡é¢˜
            \Huge\heiti\bfseries \@title \\
            \vspace{0.5cm}
            \Large\heiti \@subtitle \\
            
            \vspace{3cm}
            
            \ifmf@review
                \textcolor{red}{\Huge DRAFT / CONFIDENTIAL} \\
            \else
                % è£…é¥°çº¿
                \begin{tikzpicture}
                    \draw[thick, mf@thm@blue] (0,0) -- (\textwidth,0);
                    \draw[thick, mf@thm@blue] (0,0.1) -- (\textwidth,0.1);
                \end{tikzpicture}
            \fi
            
            \vspace{3cm}
            
            % ä¿¡æ¯å—
            \Large\songti
            \begin{tabular}{rl}
                \textbf{ä½œè€…ï¼š} & \@author \\
                \ifblank{\@advisor}{}{\textbf{å¯¼å¸ˆï¼š} & \@advisor \\}
                \textbf{æœºæ„ï¼š} & \@institute \\
                \textbf{ç‰ˆæœ¬ï¼š} & \@version \\
                \textbf{æ—¥æœŸï¼š} & \@coverdate
            \end{tabular}
            
            \vfill
            
            % åº•éƒ¨ Logo (å¯é€‰ï¼Œæ­¤å¤„ç”¨æ–‡å­—ä»£æ›¿)
            {\large\scshape MindFlow Academic Template}
            \vspace{1cm}
            
        \end{center}
    \end{titlepage}
}

\makeatother
% =========================================================
% End of MindFlow Class File
% =========================================================
